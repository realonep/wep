<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸ˆë¦¬ ê²Œì„ v0.1</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121925; --panel2:#0f1620;
      --txt:#e7edf5; --muted:#9bb0c7; --accent:#7dd3fc;
      --bad:#fb7185; --good:#86efac; --warn:#fbbf24;
      --line:#243244;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, #1b2a40 0%, var(--bg) 55%);
      color:var(--txt);
    }
    header{
      padding:18px 20px; border-bottom:1px solid var(--line);
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
    }
    h1{margin:0; font-size:18px; letter-spacing:-0.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.4}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px 28px}
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(0,0,0,0.18); color:var(--muted); font-size:12px;
    }
    .pill b{color:var(--txt); font-weight:650}
    .kpiGrid{
      display:grid; grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px; margin-top:10px;
    }
    @media (max-width: 980px){
      .kpiGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    .kpi{
      padding:10px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,0.16);
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .val{margin-top:6px; font-size:18px; font-weight:750; letter-spacing:-0.2px}
    .kpi .hint{margin-top:4px; color:var(--muted); font-size:11px}
    .val.good{color:var(--good)}
    .val.bad{color:var(--bad)}
    .val.warn{color:var(--warn)}
    .controls{
      margin-top:10px; display:grid; grid-template-columns: 1fr; gap:10px;
    }
    .btnRow{display:flex; gap:8px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid var(--line); background: rgba(0,0,0,0.18);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:650;
      cursor:pointer; transition: transform .04s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{background: rgba(255,255,255,0.06)}
    button:active{transform: translateY(1px)}
    button.primary{border-color: rgba(125,211,252,0.45); box-shadow: 0 0 0 1px rgba(125,211,252,0.10) inset}
    button.danger{border-color: rgba(251,113,133,0.45)}
    .small{font-size:12px; padding:8px 10px}
    .split{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .log{
      height: 260px; overflow:auto; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,0.18); padding:10px;
    }
    .log p{margin:0 0 8px; color:var(--muted); font-size:12px; line-height:1.45}
    .log p strong{color:var(--txt)}
    .log .news{color: var(--accent)}
    .log .warn{color: var(--warn)}
    .log .bad{color: var(--bad)}
    .log .good{color: var(--good)}
    canvas{width:100%; height:280px; display:block}
    .chartTitle{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    select, input[type="number"]{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,0.18); color:var(--txt);
      outline:none;
    }
    .footerNote{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .endingOverlay{
      position:fixed; inset:0; display:none; z-index:999;
      background:
        radial-gradient(600px 420px at 50% 35%, rgba(255,255,255,0.06), rgba(0,0,0,0.9)),
        linear-gradient(180deg, rgba(251,113,133,0.10), rgba(0,0,0,0.9));
      backdrop-filter: blur(2px);
      color:var(--txt);
    }
    .endingOverlay.show{display:block}
    .endingContent{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      text-align:center; padding:24px;
    }
    .endingCard{
      max-width:720px; border:1px solid rgba(251,113,133,0.45);
      border-radius:22px; padding:26px 22px 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.35));
      box-shadow: 0 30px 80px rgba(0,0,0,0.5);
    }
    .endingTitle{
      font-size:26px; font-weight:800; letter-spacing:-0.3px;
      text-shadow: 0 2px 12px rgba(0,0,0,0.6);
    }
    .endingArt{
      margin:16px auto 10px; width:160px; height:160px; border-radius:999px;
      background:
        radial-gradient(circle at 35% 35%, rgba(251,191,36,0.9), rgba(251,113,133,0.6) 45%, rgba(0,0,0,0.1) 46%),
        conic-gradient(from 120deg, rgba(251,113,133,0.9), rgba(0,0,0,0.1), rgba(251,191,36,0.8), rgba(0,0,0,0.1));
      border:1px solid rgba(251,113,133,0.6);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.6), 0 10px 40px rgba(0,0,0,0.6);
    }
    .endingDesc{
      margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6;
    }
    .endingActions{
      margin-top:14px; display:flex; justify-content:center; gap:10px;
    }
  </style>
</head>
<body>
<div id="endingOverlay" class="endingOverlay" aria-hidden="true">
  <div class="endingContent">
    <div class="endingCard">
      <div class="endingTitle">ê²Œì„ ì¢…ë£Œ</div>
      <div class="endingArt" aria-hidden="true"></div>
      <div id="endingText" class="endingDesc"></div>
      <div class="endingActions">
        <button id="endingRestartBtn" class="primary">ìƒˆ ê²Œì„ ì‹œì‘</button>
      </div>
    </div>
  </div>
</div>
<header>
  <div>
    <h1>ê¸ˆë¦¬ ê²Œì„ (ì—°ì¤€ ì˜ì¥ ì‹œë®¬ë ˆì´í„°) Â· HTML Prototype</h1>
    <div class="sub">
      ëª©í‘œ: ë¬¼ê°€(CPI)Â·ì‹¤ì—…ë¥ ì„ ì•ˆì •ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë©´ì„œ ê¸ˆìœµìœ„ê¸°ë¥¼ í”¼í•˜ê³  ë¯¼ì‹¬ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.<br/>
      ì „ìŸ/íŒ¬ë°ë¯¹/ê³µê¸‰ì¶©ê²©/ë²„ë¸”/ì‹ ìš©ê²½ìƒ‰/íŒŒì—… ì´ë²¤íŠ¸ê°€ ì¡°ê±´Â·í™•ë¥ ë¡œ ë°œìƒí•©ë‹ˆë‹¤.
    </div>
  </div>
  <div class="row">
    <span class="pill">í„´: <b id="month">1</b> / <span id="maxMonths">48</span>ê°œì›”</span>
    <span class="pill">ë‚œì´ë„: <b id="difficultyLabel">ë³´í†µ</b></span>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls + log -->
    <div class="card">
      <div class="split">
        <div>
          <div class="pill">ê¸°ì¤€ê¸ˆë¦¬ r: <b id="rateVal" class="mono">4.00%</b></div>
        </div>
        <div class="pill">ì‹ ë¢°ë„: <b id="credVal">70</b></div>
      </div>

      <div class="controls">
        <label>
          ë‚œì´ë„
          <select id="difficulty">
            <option value="easy">ì‰¬ì›€</option>
            <option value="normal" selected>ë³´í†µ</option>
            <option value="hard">í•˜ë“œ</option>
          </select>
        </label>

        <div class="btnRow">
          <button class="small" data-delta="-0.75">-0.75</button>
          <button class="small" data-delta="-0.50">-0.50</button>
          <button class="small" data-delta="-0.25">-0.25</button>
          <button class="small" data-delta="+0.25">+0.25</button>
          <button class="small" data-delta="+0.50">+0.50</button>
          <button class="small" data-delta="+0.75">+0.75</button>
        </div>

        <div class="split">
          <button id="nextBtn" class="primary">ë‹¤ìŒ ë‹¬ ì§„í–‰</button>
          <button id="autoBtn">ìë™ ì§„í–‰(10ê°œì›”)</button>
        </div>

        <div class="btnRow">
          <button id="resetBtn" class="danger">ìƒˆ ê²Œì„</button>
          <button id="seedBtn">ì‹œë“œ ê³ ì •/í•´ì œ</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="split">
        <div class="pill">ìµœê·¼ ì´ë²¤íŠ¸/ë¦¬ì•¡ì…˜</div>
        <div class="pill">ì •ì±… ë³€í™”: <b id="lastDelta" class="mono">+0.00</b></div>
      </div>
      <div id="log" class="log" aria-live="polite"></div>

      <div class="footerNote">
        íŒ: CPIê°€ 6%ë¥¼ ë„˜ìœ¼ë©´ â€œê¸°ëŒ€ ì¸í”Œë ˆâ€ê°€ í’€ë¦¬ë©´ì„œ ë¬¼ê°€ê°€ ë” ëˆì í•´ì§‘ë‹ˆë‹¤(ì¡ê¸° ì–´ë ¤ì›€).<br/>
        ë²„ë¸” êµ¬ê°„ì—ì„œëŠ” ê¸ˆë¦¬ë¥¼ ë” ë‚´ë¦¬ë©´ ê³ ìš©ì´ ì•„ë‹ˆë¼ ìì‚°ë§Œ ë” ì˜¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- RIGHT: KPIs + chart -->
    <div class="card">
      <div class="row">
        <span class="pill">CPI ëª©í‘œ <b>2.0%</b></span>
        <span class="pill">ì¤‘ë¦½ê¸ˆë¦¬ <b>2.5%</b></span>
        <span class="pill">ì—”ë”© ì¡°ê±´: CPIâ‰¥18 ì§€ì† / ì‹¤ì—…â‰¥16 ì§€ì† / F=100 / ë¯¼ì‹¬ ë¶•ê´´</span>
      </div>

      <div class="kpiGrid" id="kpis"></div>

      <div class="divider"></div>

      <div class="chartTitle">
        <div class="pill">ìµœê·¼ 24ê°œì›” ì¶”ì´ (CPI / ì‹¤ì—…ë¥  / ìì‚°ì§€ìˆ˜)</div>
        <div class="pill">í‘œì‹œ: <b id="chartScale" class="mono">auto</b></div>
      </div>
      <canvas id="chart" width="980" height="280"></canvas>

      <div class="footerNote">
        ì°¨íŠ¸ëŠ” ë‹¨ìˆœ ì„ í˜• ìŠ¤ì¼€ì¼ì…ë‹ˆë‹¤. (ìì‚°ì§€ìˆ˜ëŠ” ìŠ¤ì¼€ì¼ì´ ì»¤ì„œ í•¨ê»˜ í‘œì‹œí•  ë•Œ ìë™ ì •ê·œí™”ë©ë‹ˆë‹¤.)
      </div>
    </div>
  </div>
</div>

<script>
/** -------------------------
 *  RNG (seedable)
 * --------------------------*/
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function sgn(x){ return x < 0 ? -1 : (x > 0 ? 1 : 0); }

/** -------------------------
 *  Game State
 * --------------------------*/
const PARAMS = {
  targetCPI: 2.0,
  neutralRate: 2.5,
};

function defaultState(){
  return {
    month: 1,
    maxMonths: 48,
    r: 4.0,

    cpi: 3.0,
    u: 4.5,
    g: 1.5,
    a: 120.0,
    e: 2.6,
    f: 25.0,

    approval: 60.0,
    unrest: 10.0,
    credibility: 70.0,

    debt: 55.0,
    spec: 20.0,
    inequality: 40.0,

    supplyShock: 0.0,
    demandShock: 0.0,
    fearShock: 0.0,
    warIntensity: 0.0,
    pandemicIntensity: 0.0,

    lagRealRate: 0.0,
    lagTightness: 0.0,

    cpiHist: [3.0],
    uHist: [4.5],
    aHist: [120.0],

    lastRateChange: 0.0,
    lastDirection: 0,
    fHigh: false,
    cpiHigh8: false,
    luxHeat: false,
    uHigh9: false,
    stagFlag: false,
    unrestHigh70: false,
    warHigh40: false,
    pandemicHigh40: false
  };
}

let state = defaultState();

/** -------------------------
 * Difficulty (changes event rates & sensitivities)
 * --------------------------*/
const DIFF = {
  easy:   { eventMult: 0.68, shockMult: 0.80, approvalSensitivity: 0.85 },
  normal: { eventMult: 0.90, shockMult: 0.92, approvalSensitivity: 1.00 },
  hard:   { eventMult: 1.15, shockMult: 1.10, approvalSensitivity: 1.20 },
};
let difficulty = "normal";

/** -------------------------
 * Events
 * --------------------------*/
function decayShocks(s){
  s.supplyShock *= 0.80;
  s.demandShock *= 0.75;
  s.fearShock   *= 0.80;
  s.warIntensity *= 0.88;
  s.pandemicIntensity *= 0.86;
}

function chance(p, rng){ return rng() < p; }

function getEvents(){
  return [
    {
      key:"pandemic",
      headline:"ğŸ“° ì†ë³´: ê°ì—¼ë³‘ í™•ì‚°â€¦ ì´ë™ ì œí•œê³¼ ê³µê¸‰ë§ ì°¨ì§ˆ ìš°ë ¤",
      weight: 1.2,
      can: (s, rng) => {
        let base = 0.015;
        base += 0.01 * (1 - s.credibility/100);
        const m = s.month % 12;
        base += ([12,1,2].includes(m) ? 0.005 : 0);
        base -= 0.01 * (s.pandemicIntensity/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.001, 0.06), rng);
      },
      apply: (s, rng) => {
        const intensity = randBetween(35, 70, rng) * DIFF[difficulty].shockMult;
        s.pandemicIntensity = clamp(s.pandemicIntensity + intensity, 0, 100);
        s.fearShock += randBetween(8, 18, rng) * DIFF[difficulty].shockMult;
        s.supplyShock += randBetween(4, 10, rng) * DIFF[difficulty].shockMult;
        s.demandShock -= randBetween(6, 14, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(3, 8, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(1, 4, rng);
      }
    },
    {
      key:"war",
      headline:"ğŸ“° ì†ë³´: ì§€ì •í•™ì  ì¶©ëŒ ê²©í™”â€¦ ì›ìì¬Â·ì—ë„ˆì§€ ê°€ê²© ê¸‰ë“±",
      weight: 1.2,
      can: (s, rng) => {
        let base = 0.012;
        base += 0.008 * (s.cpi/10);
        base -= 0.01 * (s.warIntensity/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.001, 0.06), rng);
      },
      apply: (s, rng) => {
        const intensity = randBetween(40, 85, rng) * DIFF[difficulty].shockMult;
        s.warIntensity = clamp(s.warIntensity + intensity, 0, 100);
        s.supplyShock += randBetween(10, 22, rng) * DIFF[difficulty].shockMult;
        s.fearShock += randBetween(6, 16, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 6, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(2, 6, rng);
      }
    },
    {
      key:"supply",
      headline:"ğŸ“° ë¬¼ë¥˜Â·ì›ìì¬ ì°¨ì§ˆâ€¦ ìƒí™œë¬¼ê°€ ì••ë°• í™•ëŒ€",
      weight: 1.0,
      can: (s, rng) => {
        let base = 0.02 + 0.01*(s.cpi/8);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.005, 0.07), rng);
      },
      apply: (s, rng) => {
        s.supplyShock += randBetween(6, 14, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(1, 4, rng) * DIFF[difficulty].approvalSensitivity;
      }
    },
    {
      key:"bubble",
      headline:"ğŸ“° â€˜ì˜ëŒÂ·ë¹šíˆ¬â€™ ê´‘í’â€¦ ìì‚°ì‹œì¥ ê³¼ì—´ ì‹ í˜¸",
      weight: 1.1,
      can: (s, rng) => {
        if(s.a < 120) return false;
        const lookback = Math.min(6, s.aHist.length);
        const trend = lookback >= 2 ? (s.aHist[s.aHist.length-1] - s.aHist[s.aHist.length-lookback]) : 0;
        let base = 0.01;
        base += 0.015 * (Math.max(0, 3.0 - s.r) / 3.0);
        base += 0.02 * clamp(trend/30, 0, 1);
        base += 0.01 * (s.spec/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.002, 0.09), rng);
      },
      apply: (s, rng) => {
        s.spec = clamp(s.spec + randBetween(10, 25, rng), 0, 100);
        s.inequality = clamp(s.inequality + randBetween(3, 10, rng), 0, 100);
        s.approval -= randBetween(1, 5, rng) * DIFF[difficulty].approvalSensitivity;
        s.a += randBetween(8, 20, rng);
      }
    },
    {
      key:"crunch",
      headline:"ğŸ“° ê¸ˆìœµì‹œì¥ ê²½ìƒ‰â€¦ íšŒì‚¬ì±„ ìŠ¤í”„ë ˆë“œ í™•ëŒ€, ì€í–‰ê¶Œ ê¸´ì¥",
      weight: 1.0,
      can: (s, rng) => {
        let base = 0.006;
        base += 0.02*(s.f/100);
        base += 0.012*(Math.abs(s.lastRateChange)/1.0);
        base += 0.01*(s.debt/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.0006, 0.10), rng);
      },
      apply: (s, rng) => {
        s.f = clamp(s.f + randBetween(15, 30, rng) * DIFF[difficulty].shockMult, 0, 100);
        s.fearShock += randBetween(10, 20, rng) * DIFF[difficulty].shockMult;
        s.demandShock -= randBetween(6, 12, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 6, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(2, 6, rng);
      }
    },
    {
      key:"strike",
      headline:"ğŸ“° ë…¸ì¡° ì´íŒŒì—… ëŒì…â€¦ ì„ê¸ˆ ì¸ìƒ ìš”êµ¬ í™•ì‚°",
      weight: 0.9,
      can: (s, rng) => {
        let base = 0.008;
        base += 0.02 * (Math.max(0, s.cpi - 4.0)/6.0);
        base += 0.02 * (s.unrest/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clamp(base, 0.001, 0.08), rng);
      },
      apply: (s, rng) => {
        s.unrest = clamp(s.unrest + randBetween(8, 18, rng), 0, 100);
        s.supplyShock += randBetween(3, 8, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 5, rng) * DIFF[difficulty].approvalSensitivity;
      }
    },
  ];
}

function randBetween(a,b,rng){ return a + (b-a)*rng(); }
function randBetweenScaled(a,b,scale,rng){
  return a + (b-a)*rng()*scale + (b-a)*(1-scale)*0.5;
}

function weightedPick(cands, rng){
  const total = cands.reduce((acc, ev) => acc + (ev.weight || 1), 0);
  let r = rng() * total;
  for(const ev of cands){
    r -= (ev.weight || 1);
    if(r <= 0) return ev;
  }
  return cands[cands.length-1];
}

function maybeEvents(s, rng){
  const events = getEvents();
  const triggered = [];
  const cands1 = events.filter(ev => ev.can(s, rng));
  if(cands1.length){
    const ev = weightedPick(cands1, rng);
    ev.apply(s, rng);
    triggered.push(ev.headline);
  }
  if(rng() < 0.18 * DIFF[difficulty].eventMult){
    const cands2 = events.filter(ev => ev.can(s, rng));
    if(cands2.length){
      const ev2 = weightedPick(cands2, rng);
      ev2.apply(s, rng);
      triggered.push(ev2.headline);
    }
  }
  return triggered;
}

/** -------------------------
 * Simulation step (1 month)
 * --------------------------*/
function stepMonth(s, rng){
  const logs = [];
  decayShocks(s);
  const randScale = s.month <= 4 ? 0.5 : 1.0;

  const realRate = s.r - s.e;
  s.lagRealRate = 0.60*s.lagRealRate + 0.40*realRate;
  const tightness = s.r - PARAMS.neutralRate;
  s.lagTightness = 0.50*s.lagTightness + 0.50*tightness;

  const warDrag = 0.03*(s.warIntensity/10);
  const pandDrag = 0.04*(s.pandemicIntensity/10);

  // growth
  let g = s.g;
  g += 0.55*(PARAMS.neutralRate - s.lagRealRate);
  g -= 0.02*s.f;
  g -= 0.10*(s.supplyShock/10);
  g += 0.08*(s.demandShock/10);
  g -= warDrag;
  g -= pandDrag;
  g += randBetweenScaled(-0.4, 0.4, randScale, rng);
  g = clamp(g, -10, 8);

  // unemployment
  let u = s.u;
  u += 0.18*(-g);
  u += 0.02*(s.f/10);
  u += 0.05*(s.pandemicIntensity/20);
  u += randBetweenScaled(-0.1, 0.1, randScale, rng);
  u = clamp(u, 2.0, 20.0);

  // CPI
  let cpi = s.cpi;
  cpi += 0.10*Math.max(0, g);
  cpi += 0.08*(s.e - PARAMS.targetCPI);
  cpi -= 0.22*(s.lagTightness);
  if(s.lagRealRate > 0.8) cpi -= 0.10*(s.lagRealRate - 0.8);
  cpi += 0.26*(s.supplyShock/10);
  cpi += 0.10*(s.warIntensity/20);

  // nonlinearity / stickiness
  if(cpi > 6) cpi += 0.04*(cpi-6);
  if(cpi > 10) cpi += 0.06*(cpi-10);

  cpi += randBetweenScaled(-0.15, 0.15, randScale, rng);
  cpi = clamp(cpi, -1.0, 25.0);

  // expected inflation
  let credDamp = (1.0 - s.credibility/150);
  let e = s.e;
  e += 0.20*(cpi - PARAMS.targetCPI)*credDamp;

  // direction change penalty (flip-flop)
  const dir = sgn(s.lastRateChange);
  if(s.lastDirection !== 0 && dir !== 0 && dir !== s.lastDirection){
    e += 0.25;
    s.credibility -= 2.0;
    logs.push("âš ï¸ ì •ì±… ë°©í–¥ ê¸‰ë³€ìœ¼ë¡œ ì‹ ë¢°ë„ í•˜ë½");
  }

  if(cpi >= 8) s.credibility -= 1.5;
  s.credibility = clamp(s.credibility, 0, 100);
  e = clamp(e, 0, 15);

  // assets
  let a = s.a;
  a += 3.2*(PARAMS.neutralRate - s.r);
  a += 0.25*(s.spec/10);
  a -= 0.30*(s.fearShock/5);
  a -= 0.25*(s.f/10);

  // crash risk
  let crashProb = 0;
  crashProb += 0.002*Math.max(0, s.f - 65);
  crashProb += 0.01*Math.max(0, Math.abs(s.lastRateChange) - 0.5);
  crashProb += 0.006*Math.max(0, s.spec - 70)/10;
  crashProb = clamp(crashProb, 0, 0.35);

  if(rng() < crashProb){
  const drop = randBetween(18, 45, rng);
    a -= drop;
    s.fearShock += randBetween(10, 20, rng);
    s.f = clamp(s.f + randBetween(8, 16, rng), 0, 100);
    s.unrest = clamp(s.unrest + randBetween(5, 12, rng), 0, 100);
    logs.push(`ğŸ“‰ ìì‚°ì‹œì¥ ê¸‰ë½(ë²„ë¸” ë¶•ê´´) -${drop.toFixed(1)}`);
  }

  a += randBetweenScaled(-2, 2, randScale, rng);
  a = clamp(a, 50, 300);

  // financial stress
  let f = s.f;
  f += 6.0*Math.abs(s.lastRateChange);
  f += 0.25*(s.debt/10);
  f += 0.20*Math.max(0, (a - 150)/10);
  f += 0.35*(s.fearShock/10);
  f -= 0.45*Math.max(0, s.r - PARAMS.neutralRate);
  f -= 0.20*(s.lagRealRate);
  f += randBetweenScaled(-1.5, 1.5, randScale, rng);
  f = clamp(f, 0, 100);

  // speculation & debt
  let spec = s.spec;
  const trendA = (a - s.a);
  spec += 0.20*Math.max(0, (PARAMS.neutralRate - s.r))*10;
  spec += 0.08*Math.max(0, trendA);
  spec -= 0.10*(f/10);
  spec += randBetweenScaled(-1.5, 1.5, randScale, rng);
  spec = clamp(spec, 0, 100);

  let debt = s.debt;
  debt += 0.16*Math.max(0, (PARAMS.neutralRate - s.r))*10;
  debt += 0.06*Math.max(0, g);
  debt -= 0.10*Math.max(0, (f - 60)/10);
  debt += randBetweenScaled(-0.9, 0.9, randScale, rng);
  debt = clamp(debt, 0, 100);

  // inequality
  let ineq = s.inequality;
  ineq += 0.06*Math.max(0, (a - 140)/10);
  ineq += 0.04*Math.max(0, (cpi - 3.0));
  ineq += 0.10*Math.max(0, (u - 6.0));
  ineq += randBetweenScaled(-0.7, 0.7, randScale, rng);
  ineq = clamp(ineq, 0, 100);

  // approval & unrest
  let approval = s.approval;
  const sens = DIFF[difficulty].approvalSensitivity;
  approval -= sens * 1.3*Math.max(0, (cpi - 3.0));
  approval -= sens * 1.0*Math.max(0, (u - 5.0));
  approval += 0.03*Math.max(0, (a - 120));
  approval -= 0.06*(ineq/10);
  approval += 0.03*(s.credibility - 60);
  approval += randBetweenScaled(-1.5, 1.5, randScale, rng);
  approval = clamp(approval, 0, 100);

  let unrest = s.unrest;
  unrest += 0.8*Math.max(0, (cpi - 4.0));
  unrest += 0.9*Math.max(0, (u - 6.0));
  unrest += 0.4*Math.max(0, (ineq - 50)/10);
  unrest += 0.2*Math.max(0, (f - 70)/10);
  unrest -= 0.25*Math.max(0, (approval - 55)/10);
  unrest += randBetweenScaled(-1.0, 1.0, randScale, rng);
  unrest = clamp(unrest, 0, 100);

  // write back
  s.g=g; s.u=u; s.cpi=cpi; s.e=e; s.a=a; s.f=f;
  s.spec=spec; s.debt=debt; s.inequality=ineq;
  s.approval=approval; s.unrest=unrest;

  // histories
  s.cpiHist.push(s.cpi);
  s.uHist.push(s.u);
  s.aHist.push(s.a);
  if(s.cpiHist.length > 24){
    s.cpiHist = s.cpiHist.slice(-24);
    s.uHist = s.uHist.slice(-24);
    s.aHist = s.aHist.slice(-24);
  }

  return logs;
}

/** -------------------------
 * Endings & reactions
 * --------------------------*/
function checkEnding(s){
  const last3cpi = s.cpiHist.slice(-3);
  const last3u = s.uHist.slice(-3);
  if(s.cpi >= 18 && last3cpi.length===3 && last3cpi.every(x=>x>=18)) return "ğŸ’¥ ì—”ë”©: ë¬¼ê°€ í­ë“±(í†µì œ ë¶ˆëŠ¥) â€” ì¤‘ì•™ì€í–‰ ì‹ ë¢° ë¶•ê´´";
  if(s.u >= 16 && last3u.length===3 && last3u.every(x=>x>=16)) return "ğŸ•³ï¸ ì—”ë”©: ëŒ€ê³µí™© â€” ì‹¤ì—…ë¥  ì¥ê¸° ê³ ì°©";
  if(s.f >= 100) return "ğŸ¦ ì—”ë”©: ê¸ˆìœµì‹œìŠ¤í…œ ë¶•ê´´ â€” ì‹ ìš© ê²½ìƒ‰ìœ¼ë¡œ ê²½ì œ ì •ì§€";
  if(s.approval <= 2 && s.unrest >= 95) return "ğŸ”¥ ì—”ë”©: ì‚¬íšŒ ë¶ˆì•ˆ í­ë°œ â€” ì •ì±… ì§€ì† ë¶ˆê°€ëŠ¥";
  if(s.month > s.maxMonths){
    const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
    const avgCPI = avg(s.cpiHist.slice(-12));
    const avgU = avg(s.uHist.slice(-12));
    if((1.5<=avgCPI && avgCPI<=3.5) && (3.5<=avgU && avgU<=6.5) && s.f<70 && s.approval>35){
      return "ğŸ ì—”ë”©: ëª…ì˜ˆë¡œìš´ ì—°ì°©ë¥™ â€” ë¬¼ê°€ì™€ ê³ ìš©ì˜ ê· í˜•ì„ ì§€ì¼œëƒˆìŠµë‹ˆë‹¤.";
    }
    return "ğŸ ì—”ë”©: ë²„í‹´ ê²ƒë§Œìœ¼ë¡œë„ ì„±ê³¼ â€” ë‹¤ë§Œ ë¶ˆì•ˆì •ì´ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.";
  }
  return null;
}

function reactions(s){
  const out = [];
  const luxCond = s.cpi >= 7 && s.a >= 160 && s.u <= 6;
  const basketCond = s.cpi >= 8;
  const uCond = s.u >= 9;
  const stagCond = s.cpi >= 7 && s.g <= -0.2 && s.u >= 7.5;
  const fCond = s.f >= 75;
  const unrestCond = s.unrest >= 70;
  const warCond = s.warIntensity >= 40;
  const panCond = s.pandemicIntensity >= 40;

  if(luxCond && !s.luxHeat) out.push("ğŸ‘œ ê±°ë¦¬: â€˜ëª…í’ˆ ì˜¤í”ˆëŸ°â€™â€¦ ì²´ê°ë¬¼ê°€ëŠ” ì˜¤ë¥´ëŠ”ë° ê³¼ì‹œ ì†Œë¹„ê°€ ê³¼ì—´ë©ë‹ˆë‹¤.");
  if(basketCond && !s.cpiHigh8) out.push("ğŸ§¾ ì‹œë¯¼: â€˜ì¥ë°”êµ¬ë‹ˆê°€ ë¬´ì„­ë‹¤â€™â€¦ ìƒí•„í’ˆ ê°€ê²© ê¸‰ë“±ì— í•­ì˜ê°€ ì»¤ì§‘ë‹ˆë‹¤.");
  if(uCond && !s.uHigh9) out.push("ğŸª§ ë…¸ë™: í•´ê³  í™•ì‚°â€¦ ì‹œìœ„Â·íŒŒì—… ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.");
  if(stagCond && !s.stagFlag) out.push("âš ï¸ ê²½ê³ : ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜ ì§•í›„(ë¬¼ê°€â†‘ ê²½ê¸°â†“ ì‹¤ì—…â†‘).");
  if(fCond && !s.fHigh) out.push("ğŸ¦ ì‹œì¥: â€˜ëˆì´ ë§ˆë¥¸ë‹¤â€™â€¦ ê¸ˆìœµ ê²½ìƒ‰ì´ ì‹¤ë¬¼ê²½ì œë¡œ ë²ˆì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  if(unrestCond && !s.unrestHigh70) out.push("ğŸ”¥ ì‚¬íšŒ: ëŒ€ê·œëª¨ ì§‘íšŒ ì¡°ì§â€¦ ì •ì¹˜ê¶Œ ì••ë°•ì´ í¬ê²Œ ì¦ê°€í•©ë‹ˆë‹¤.");
  if(warCond && !s.warHigh40) out.push("ğŸª– ì§€ì •í•™: ì „ìŸ ë¦¬ìŠ¤í¬ ì§€ì†â€¦ ì—ë„ˆì§€Â·ì›ìì¬ ê²½ë¡œë¡œ ë¬¼ê°€ ì••ë°•ì´ ê¸¸ì–´ì§‘ë‹ˆë‹¤.");
  if(panCond && !s.pandemicHigh40) out.push("ğŸ¦  ë³´ê±´: íŒ¬ë°ë¯¹ ì—¬íŒŒ ì§€ì†â€¦ ê³ ìš© íšŒë³µì´ ë”ë”œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

  s.luxHeat = luxCond;
  s.cpiHigh8 = basketCond;
  s.uHigh9 = uCond;
  s.stagFlag = stagCond;
  s.fHigh = fCond;
  s.unrestHigh70 = unrestCond;
  s.warHigh40 = warCond;
  s.pandemicHigh40 = panCond;
  return out;
}

/** -------------------------
 * UI rendering
 * --------------------------*/
const el = (id)=>document.getElementById(id);
const logEl = el("log");
const kpisEl = el("kpis");
const chart = el("chart");
const ctx = chart.getContext("2d");
const endingOverlay = el("endingOverlay");
const endingText = el("endingText");
const endingRestartBtn = el("endingRestartBtn");

function fmt(x, d=2){ return Number(x).toFixed(d); }
function kpiColor(label, v){
  // simple threshold coloring
  if(label==="CPI"){
    if(v<=3.5) return "good";
    if(v<=6.0) return "warn";
    return "bad";
  }
  if(label==="ì‹¤ì—…ë¥ "){
    if(v<=6.0) return "good";
    if(v<=9.0) return "warn";
    return "bad";
  }
  if(label==="ì„±ì¥ë¥ "){
    if(v>=1.0) return "good";
    if(v>=0.0) return "warn";
    return "bad";
  }
  if(label==="ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤"){
    if(v<55) return "good";
    if(v<75) return "warn";
    return "bad";
  }
  if(label==="ë¯¼ì‹¬"){
    if(v>=55) return "good";
    if(v>=35) return "warn";
    return "bad";
  }
  if(label==="ì‚¬íšŒë¶ˆì•ˆ"){
    if(v<35) return "good";
    if(v<70) return "warn";
    return "bad";
  }
  // default
  return v >= 0 ? "warn" : "bad";
}

function renderKPIs(){
  const items = [
    {label:"CPI", val: state.cpi, unit:"% YoY", hint:"ë¬¼ê°€"},
    {label:"ì‹¤ì—…ë¥ ", val: state.u, unit:"%", hint:"ê³ ìš©"},
    {label:"ì„±ì¥ë¥ ", val: state.g, unit:"%", hint:"ê²½ê¸°"},
    {label:"ìì‚°ì§€ìˆ˜", val: state.a, unit:"index", hint:"ì£¼ì‹+ë¶€ë™ì‚°(í•©ì„±)"},
    {label:"ê¸°ëŒ€ì¸í”Œë ˆ", val: state.e, unit:"%", hint:"ì‹¬ë¦¬/ê¸°ëŒ€"},
    {label:"ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤", val: state.f, unit:"/100", hint:"ìœ„ê¸° ë¦¬ìŠ¤í¬"},
    {label:"ë¯¼ì‹¬", val: state.approval, unit:"/100", hint:"ì§€ì§€ìœ¨"},
    {label:"ì‚¬íšŒë¶ˆì•ˆ", val: state.unrest, unit:"/100", hint:"ì‹œìœ„/íŒŒì—…"},
  ];
  kpisEl.innerHTML = items.map(it=>{
    const cls = kpiColor(it.label, it.val);
    return `
      <div class="kpi">
        <div class="label">${it.label} <span class="mono" style="color:var(--muted)">(${it.unit})</span></div>
        <div class="val ${cls}">${fmt(it.val, it.label==="ìì‚°ì§€ìˆ˜"?1:2)}</div>
        <div class="hint">${it.hint}</div>
      </div>
    `;
  }).join("");
}

function pushLog(lines, type=""){
  const frag = document.createDocumentFragment();
  for(const line of lines){
    const p = document.createElement("p");
    if(type) p.className = type;
    p.innerHTML = line;
    frag.appendChild(p);
  }
  logEl.appendChild(frag);
  logEl.scrollTop = logEl.scrollHeight;
}

function clearLog(){
  logEl.innerHTML = "";
}

function renderTop(){
  el("month").textContent = String(state.month);
  el("maxMonths").textContent = String(state.maxMonths);
  el("rateVal").textContent = `${fmt(state.r,2)}%`;
  el("credVal").textContent = `${Math.round(state.credibility)}`;
  el("lastDelta").textContent = `${(state.lastRateChange>=0?"+":"")}${fmt(state.lastRateChange,2)}`;
  el("difficultyLabel").textContent = difficulty==="easy" ? "ì‰¬ì›€" : (difficulty==="hard" ? "í•˜ë“œ" : "ë³´í†µ");
}

function drawChart(){
  // Basic line chart with normalization for asset index
  const w = chart.width, h = chart.height;
  ctx.clearRect(0,0,w,h);

  // frame
  ctx.globalAlpha = 1;
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  ctx.strokeRect(0.5,0.5,w-1,h-1);

  const padL=44, padR=12, padT=12, padB=24;
  const innerW = w - padL - padR;
  const innerH = h - padT - padB;

  const n = state.cpiHist.length;
  const xs = (i)=> padL + (innerW * (n<=1 ? 0 : i/(n-1)));
  const y = (v, vmin, vmax)=>{
    const t = (v - vmin) / (vmax - vmin || 1);
    return padT + (1 - t)*innerH;
  };

  // ranges
  const cpiMin = Math.min(...state.cpiHist, 0);
  const cpiMax = Math.max(...state.cpiHist, 8);
  const uMin = Math.min(...state.uHist, 2);
  const uMax = Math.max(...state.uHist, 12);
  const aMin = Math.min(...state.aHist, 70);
  const aMax = Math.max(...state.aHist, 200);

  // normalize A to 0~1 for shared plot
  const normA = state.aHist.map(v => (v - aMin)/(aMax - aMin || 1));
  const normCPI = state.cpiHist.map(v => (v - cpiMin)/(cpiMax - cpiMin || 1));
  const normU = state.uHist.map(v => (v - uMin)/(uMax - uMin || 1));

  el("chartScale").textContent = "auto";

  // grid lines
  ctx.strokeStyle = "rgba(255,255,255,0.06)";
  for(let j=1;j<=4;j++){
    const yy = padT + (innerH*j/5);
    ctx.beginPath();
    ctx.moveTo(padL, yy);
    ctx.lineTo(padL+innerW, yy);
    ctx.stroke();
  }

  // legend (no colors requested? user did not forbid; but to keep simple, use different alpha/line patterns)
  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("CPI", padL, h-8);
  ctx.fillText("U", padL+60, h-8);
  ctx.fillText("A(ì •ê·œí™”)", padL+105, h-8);

  // draw lines with varying alpha and dash
  function plot(arrNorm, dash, alpha){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.setLineDash(dash);
    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const xx = xs(i);
      const yy = padT + (1-arrNorm[i]) * innerH;
      if(i===0) ctx.moveTo(xx,yy);
      else ctx.lineTo(xx,yy);
    }
    ctx.stroke();
    ctx.restore();
  }
  plot(normCPI, [], 0.95);
  plot(normU, [6,4], 0.70);
  plot(normA, [2,4], 0.55);

  // y-axis labels (approx)
  ctx.fillStyle = "rgba(255,255,255,0.45)";
  ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif";
  ctx.fillText(`CPI ${cpiMin.toFixed(1)}~${cpiMax.toFixed(1)}`, 8, 22);
  ctx.fillText(`U ${uMin.toFixed(1)}~${uMax.toFixed(1)}`, 8, 38);
  ctx.fillText(`A ${aMin.toFixed(0)}~${aMax.toFixed(0)}`, 8, 54);

  // last point marker
  const lastX = xs(n-1);
  const lastY = padT + (1 - normCPI[n-1]) * innerH;
  ctx.beginPath();
  ctx.fillStyle = "rgba(125,211,252,0.9)";
  ctx.arc(lastX, lastY, 3.2, 0, Math.PI*2);
  ctx.fill();
}

function renderAll(){
  renderTop();
  renderKPIs();
  drawChart();
}

/** -------------------------
 * Sound
 * --------------------------*/
let audioCtx = null;
let audioUnlocked = false;
function ensureAudio(){
  if(audioUnlocked) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const buf = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.start(0);
    audioUnlocked = true;
  }catch(e){
    audioUnlocked = false;
  }
}

function playTone({freq=440, dur=0.18, type="sine", gain=0.06, slide=0, jitter=0, detune=0}){
  if(!audioUnlocked || !audioCtx) return;
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  const base = freq + (Math.random()*2-1)*jitter;
  osc.frequency.setValueAtTime(base, now);
  if(slide){
    osc.frequency.linearRampToValueAtTime(base + slide, now + dur);
  }
  if(detune) osc.detune.setValueAtTime(detune, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain), now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
  osc.connect(g);
  g.connect(audioCtx.destination);
  osc.start(now);
  osc.stop(now + dur + 0.05);
}

function playEventSound(line){
  const t = line || "";
  if(/ì „ìŸ|ì¶©ëŒ|ê¸ˆìœµì‹œì¥|ê²½ìƒ‰|ë¶•ê´´/.test(t)){
    playTone({freq:140, dur:0.28, type:"sawtooth", gain:0.08, slide:-40});
    playTone({freq:90, dur:0.22, type:"square", gain:0.05, slide:-20, detune:-20});
    return;
  }
  if(/íŒ¬ë°ë¯¹|ê°ì—¼ë³‘/.test(t)){
    playTone({freq:220, dur:0.32, type:"triangle", gain:0.06, slide:-80});
    return;
  }
  if(/ë²„ë¸”|ê³¼ì—´|ìì‚°/.test(t)){
    playTone({freq:520, dur:0.12, type:"sine", gain:0.05, slide:80});
    playTone({freq:720, dur:0.08, type:"sine", gain:0.03, slide:-40});
    return;
  }
  if(/íŒŒì—…|ë…¸ì¡°/.test(t)){
    playTone({freq:180, dur:0.22, type:"square", gain:0.06, slide:-30});
    return;
  }
  if(/ë¬¼ë¥˜|ì›ìì¬|ìƒí™œë¬¼ê°€/.test(t)){
    playTone({freq:260, dur:0.18, type:"triangle", gain:0.05, slide:-20});
    return;
  }
  playTone({freq:330, dur:0.16, type:"sine", gain:0.04});
}

function playReactionSound(line){
  const t = line || "";
  if(/ê²½ê³ |ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜/.test(t)){
    playTone({freq:420, dur:0.18, type:"triangle", gain:0.05, slide:-60});
    return;
  }
  if(/ì‚¬íšŒ|ì‹œìœ„|ë¶ˆì•ˆ|í­ë°œ/.test(t)){
    playTone({freq:160, dur:0.24, type:"sawtooth", gain:0.07, slide:-40});
    return;
  }
  if(/ì‹œì¥|ê¸ˆìœµ/.test(t)){
    playTone({freq:240, dur:0.18, type:"square", gain:0.05, slide:-20});
    return;
  }
  if(/ì‹œë¯¼|ì¥ë°”êµ¬ë‹ˆ|ë¬¼ê°€/.test(t)){
    playTone({freq:300, dur:0.14, type:"triangle", gain:0.04, slide:-10});
    return;
  }
  playTone({freq:360, dur:0.12, type:"sine", gain:0.035});
}

function playEndingSound(){
  playTone({freq:120, dur:0.35, type:"sawtooth", gain:0.09, slide:-80});
  setTimeout(()=>playTone({freq:90, dur:0.35, type:"square", gain:0.07, slide:-60}), 80);
  setTimeout(()=>playTone({freq:60, dur:0.4, type:"triangle", gain:0.06, slide:-40}), 160);
}

/** -------------------------
 * Policy control
 * --------------------------*/
function applyRateDelta(delta){
  delta = clamp(delta, -0.75, 0.75);
  const newR = clamp(state.r + delta, 0.0, 12.0);
  state.lastRateChange = delta;
  const d = sgn(delta);
  if(d !== 0) state.lastDirection = d;
  state.r = newR;

  // aggressive move penalty if CPI not hot
  if(Math.abs(delta) >= 0.5 && state.cpi < 5){
    state.credibility = clamp(state.credibility - 1.5, 0, 100);
  }
}

/** -------------------------
 * One turn
 * --------------------------*/
let rng = Math.random;
let seedMode = false;
let seedValue = 123456789;

function stepTurn(){
  // 1) Events before macro step (like breaking news)
  const eventLines = maybeEvents(state, rng);

  // 2) Macro step
  const simLogs = stepMonth(state, rng);

  // 3) Reactions
  const react = reactions(state);

  // 4) Advance time
  state.month += 1;

  // 5) Logging
  if(eventLines.length){
    pushLog(eventLines.map(x => `<span class="news">${x}</span>`));
    eventLines.forEach(line => playEventSound(line));
  }
  if(simLogs.length){
    pushLog(simLogs.map(x => `<span class="warn">${x}</span>`));
  }
  if(react.length){
    pushLog(react.map(x => `<strong>${x}</strong>`));
    react.forEach(line => playReactionSound(line));
  }

  // 6) Check ending
  const ending = checkEnding(state);
  renderAll();
  if(ending){
    pushLog([`<span class="bad"><strong>${ending}</strong></span>`]);
    endingText.textContent = ending;
    endingOverlay.classList.add("show");
    endingOverlay.setAttribute("aria-hidden", "false");
    playEndingSound();
    el("nextBtn").disabled = true;
    el("autoBtn").disabled = true;
  }
}

function newGame(){
  state = defaultState();
  state.maxMonths = 48;
  el("nextBtn").disabled = false;
  el("autoBtn").disabled = false;
  endingOverlay.classList.remove("show");
  endingOverlay.setAttribute("aria-hidden", "true");
  clearLog();
  pushLog([
    `<strong>ìƒˆ ê²Œì„ ì‹œì‘</strong> â€” ê¸°ì¤€ê¸ˆë¦¬ë¥¼ ì¡°ì ˆí•˜ì—¬ CPIì™€ ì‹¤ì—…ë¥ ì„ ê´€ë¦¬í•˜ì‹­ì‹œì˜¤.`,
    `ì „ìŸ/íŒ¬ë°ë¯¹/ë²„ë¸”/ì‹ ìš©ê²½ìƒ‰ì´ í•œ ë²ˆ í„°ì§€ë©´ â€œì‹œì°¨â€ ë•Œë¬¸ì— ë’¤ëŠ¦ê²Œ ì§€í‘œê°€ ë” ë‚˜ë¹ ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  ], "");
  renderAll();
}

/** -------------------------
 * Wire UI
 * --------------------------*/
document.querySelectorAll("button[data-delta]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    ensureAudio();
    const delta = Number(btn.dataset.delta);
    applyRateDelta(delta);
    renderAll();
  });
});

el("nextBtn").addEventListener("click", ()=>{
  ensureAudio();
  stepTurn();
});

el("autoBtn").addEventListener("click", ()=>{
  ensureAudio();
  // run 10 months quickly
  for(let i=0;i<10;i++){
    if(el("nextBtn").disabled) break;
    stepTurn();
  }
});

el("resetBtn").addEventListener("click", ()=>{
  newGame();
});

endingRestartBtn.addEventListener("click", ()=>{
  ensureAudio();
  newGame();
});

el("difficulty").addEventListener("change", (e)=>{
  difficulty = e.target.value;
  renderAll();
});

el("seedBtn").addEventListener("click", ()=>{
  seedMode = !seedMode;
  if(seedMode){
    rng = mulberry32(seedValue);
    pushLog([`<span class="good">âœ… ì‹œë“œ ê³ ì • ON (seed=${seedValue}) â€” ê°™ì€ íë¦„ìœ¼ë¡œ ë°˜ë³µ í”Œë ˆì´ ê°€ëŠ¥</span>`]);
  } else {
    rng = Math.random;
    pushLog([`<span class="good">âœ… ì‹œë“œ ê³ ì • OFF â€” ë§¤ë²ˆ ëœë¤</span>`]);
  }
});

(function init(){
  // default RNG
  rng = Math.random;
  renderAll();
  newGame();
})();
</script>
</body>
</html>
