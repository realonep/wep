<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸ˆë¦¬ ê²Œì„ v0.1</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121925; --panel2:#0f1620;
      --txt:#e7edf5; --muted:#9bb0c7; --accent:#7dd3fc;
      --bad:#fb7185; --good:#86efac; --warn:#fbbf24;
      --line:#243244;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, #1b2a40 0%, var(--bg) 55%);
      color:var(--txt);
    }
    header{
      padding:18px 20px; border-bottom:1px solid var(--line);
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
    }
    h1{margin:0; font-size:18px; letter-spacing:-0.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.4}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 16px 28px}
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(0,0,0,0.18); color:var(--muted); font-size:12px;
    }
    .pill b{color:var(--txt); font-weight:650}
    .rateVal{color: var(--warn); font-weight:800; font-size:18px}
    .kpiGrid{
      display:grid; grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px; margin-top:10px;
    }
    @media (max-width: 980px){
      .kpiGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    .kpi{
      padding:10px; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,0.16);
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .val{margin-top:6px; font-size:18px; font-weight:750; letter-spacing:-0.2px}
    .kpi .hint{margin-top:4px; color:var(--muted); font-size:11px}
    .val.good{color:var(--good)}
    .val.bad{color:var(--bad)}
    .val.warn{color:var(--warn)}
    .controls{
      margin-top:10px; display:grid; grid-template-columns: 1fr; gap:10px;
    }
    .btnRow{display:flex; gap:8px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid var(--line); background: rgba(0,0,0,0.18);
      color:var(--txt); padding:10px 12px; border-radius:12px; font-weight:650;
      cursor:pointer; transition: transform .04s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{background: rgba(255,255,255,0.06)}
    button:active{transform: translateY(1px)}
    button.primary{border-color: rgba(125,211,252,0.45); box-shadow: 0 0 0 1px rgba(125,211,252,0.10) inset}
    button.danger{border-color: rgba(251,113,133,0.45)}
    .small{font-size:12px; padding:8px 10px}
    .split{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .log{
      height: 260px; overflow:auto; border:1px solid var(--line); border-radius:14px;
      background: rgba(0,0,0,0.18); padding:10px;
    }
    .log p{margin:0 0 8px; color:var(--muted); font-size:12px; line-height:1.45}
    .log p strong{color:var(--txt)}
    .log .news{color: var(--accent)}
    .log .warn{color: var(--warn)}
    .log .bad{color: var(--bad)}
    .log .good{color: var(--good)}
    canvas{width:100%; height:280px; display:block}
    .chartTitle{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    select, input[type="number"]{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,0.18); color:var(--txt);
      outline:none;
    }
    .footerNote{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.5}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .endingOverlay{
      position:fixed; inset:0; display:none; z-index:999;
      background:
        radial-gradient(600px 420px at 50% 35%, rgba(255,255,255,0.06), rgba(0,0,0,0.9)),
        linear-gradient(180deg, rgba(251,113,133,0.10), rgba(0,0,0,0.9));
      backdrop-filter: blur(2px);
      color:var(--txt);
    }
    .endingOverlay.show{display:block}
    .endingContent{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      text-align:center; padding:24px;
    }
    .endingCard{
      max-width:720px; border:1px solid rgba(251,113,133,0.45);
      border-radius:22px; padding:26px 22px 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.35));
      box-shadow: 0 30px 80px rgba(0,0,0,0.5);
    }
    .endingTitle{
      font-size:26px; font-weight:800; letter-spacing:-0.3px;
      text-shadow: 0 2px 12px rgba(0,0,0,0.6);
    }
    .endingArt{
      margin:16px auto 10px; width:160px; height:160px; border-radius:999px;
      background:
        radial-gradient(circle at 35% 35%, rgba(251,191,36,0.9), rgba(251,113,133,0.6) 45%, rgba(0,0,0,0.1) 46%),
        conic-gradient(from 120deg, rgba(251,113,133,0.9), rgba(0,0,0,0.1), rgba(251,191,36,0.8), rgba(0,0,0,0.1));
      border:1px solid rgba(251,113,133,0.6);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.6), 0 10px 40px rgba(0,0,0,0.6);
    }
    .endingDesc{
      margin-top:10px; color:var(--muted); font-size:13px; line-height:1.6;
      white-space: pre-line;
    }
    .endingActions{
      margin-top:14px; display:flex; justify-content:center; gap:10px;
    }
    .introOverlay{
      position:fixed; inset:0; display:none; z-index:1000;
      background: radial-gradient(900px 600px at 50% 30%, rgba(255,255,255,0.04), rgba(0,0,0,0.95));
      color:var(--txt);
    }
    .introOverlay.show{display:block}
    .startOverlay{
      position:fixed; inset:0; display:none; z-index:1001;
      background:
        radial-gradient(700px 520px at 50% 30%, rgba(255,255,255,0.08), rgba(0,0,0,0.95)),
        linear-gradient(180deg, rgba(251,113,133,0.12), rgba(0,0,0,0.9));
      color:var(--txt);
    }
    .startOverlay.show{display:block}
    .startCard{
      max-width:820px; width:min(94vw, 820px);
      border:1px solid rgba(251,113,133,0.55); border-radius:22px; overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.35));
      box-shadow: 0 30px 90px rgba(0,0,0,0.6);
      padding:30px 28px;
    }
    .startTitle{font-size:34px; font-weight:850; letter-spacing:-0.4px; text-align:center}
    .startBy{margin-top:8px; color:var(--muted); font-size:13px; letter-spacing:0.2px; text-align:center}
    .startActions{margin-top:20px; display:flex; justify-content:center}
    .startBtn{
      font-size:18px; padding:14px 26px; border-radius:14px;
      border-color: rgba(125,211,252,0.6);
      box-shadow: 0 0 0 1px rgba(125,211,252,0.18) inset, 0 10px 30px rgba(0,0,0,0.35);
    }
    .introContent{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .introCard{
      max-width:860px; width:min(92vw, 860px);
      max-height:80vh; display:flex; flex-direction:column; position:relative;
      border:1px solid var(--line); border-radius:18px; overflow:hidden;
      background: rgba(0,0,0,0.35); box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }
    .introVideo{
      width:100%; height:auto; max-height:calc(80vh - 56px);
      display:block; background:#000; object-fit:contain;
    }
    .introActions{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border:1px solid var(--line); border-radius:12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.35));
      backdrop-filter: blur(2px);
    }
    .introActions .row{display:flex; gap:8px; align-items:center}
    .startFlash{
      position:fixed; inset:0; pointer-events:none; opacity:0; z-index:999;
      background:
        radial-gradient(600px 420px at 50% 40%, rgba(125,211,252,0.35), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(125,211,252,0.18), rgba(0,0,0,0));
      transition: opacity 0.45s ease;
    }
    .startFlash.show{opacity:1}
    .guideOverlay{
      position:fixed; inset:0; z-index:998; display:none;
      background:
        radial-gradient(700px 520px at 50% 35%, rgba(0,0,0,0.85), rgba(0,0,0,0.95)),
        rgba(0,0,0,0.85);
      color:var(--txt);
      backdrop-filter: blur(2px);
    }
    .guideOverlay.show{display:block}
    .guideCard{
      max-width:820px; width:min(92vw, 820px);
      border:1px solid rgba(255,255,255,0.18); border-radius:18px;
      background: rgba(8,10,14,0.96);
      box-shadow: 0 24px 90px rgba(0,0,0,0.7);
      padding:22px 24px;
    }
    .guideTitle{font-size:20px; font-weight:800; letter-spacing:-0.2px}
    .guideBody{margin-top:10px; color:#d7e0ea; font-size:13px; line-height:1.65}
    .guideGrid{
      display:grid; grid-template-columns: 1.1fr 0.9fr; gap:16px;
    }
    @media (max-width: 820px){
      .guideGrid{grid-template-columns: 1fr}
    }
    .guideSectionTitle{font-weight:800; color:var(--txt); margin:6px 0}
    .guideBody b{color:var(--txt)}
    .guideActions{margin-top:14px; display:flex; justify-content:center}
    .guideActions .primary{min-width:140px}
    .tutorPulse{
      box-shadow: 0 0 0 0 rgba(125,211,252,0.45);
      animation: tutorPulse 1.2s ease-in-out infinite;
    }
    @keyframes tutorPulse{
      0%{box-shadow: 0 0 0 0 rgba(125,211,252,0.45)}
      70%{box-shadow: 0 0 0 8px rgba(125,211,252,0.0)}
      100%{box-shadow: 0 0 0 0 rgba(125,211,252,0.0)}
    }
    .kpi{position:relative}
    .kpi[data-tip]::after{
      content: attr(data-tip);
      position:absolute; left:8px; right:8px; bottom:100%;
      transform: translateY(-8px);
      background: rgba(0,0,0,0.85);
      border:1px solid var(--line);
      border-radius:10px; padding:8px 10px;
      font-size:11px; line-height:1.45; color:var(--txt);
      opacity:0; pointer-events:none; transition: opacity .15s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    .kpi:hover::after{opacity:1}
    #chartWrap{position:relative}
    #chartWrap::after{
      content: "CPI(ì‹¤ì„ ), U=ì‹¤ì—…ë¥ (ì ì„ ), A=ìì‚°ì§€ìˆ˜(ì ì„ ) â€” ìµœê·¼ 24ê°œì›” ì¶”ì´ì…ë‹ˆë‹¤.";
      position:absolute; left:10px; right:10px; bottom:100%;
      transform: translateY(-8px);
      background: rgba(0,0,0,0.85);
      border:1px solid var(--line);
      border-radius:10px; padding:8px 10px;
      font-size:11px; line-height:1.45; color:var(--txt);
      opacity:0; pointer-events:none; transition: opacity .15s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }
    #chartWrap:hover::after{opacity:1}
  </style>
</head>
<body>
<div id="startOverlay" class="startOverlay show" aria-hidden="false">
  <div class="introContent">
    <div class="startCard">
      <div class="startTitle">ì—°ì¤€ ì˜ì¥ì´ ë˜ì–´ë³´ì!! ver 1.0</div>
      <div class="startBy">by ì¼ìƒì•„ë¹ </div>
      <div class="startActions">
        <button id="startBtn" class="primary startBtn">ì‹œì‘</button>
      </div>
    </div>
  </div>
</div>
<div id="introOverlay" class="introOverlay" aria-hidden="true">
  <div class="introContent">
    <div class="introCard">
      <video id="introVideo" class="introVideo" src="intro.MP4" autoplay muted playsinline></video>
      <div class="introActions">
        <div class="pill">ì˜¤í”„ë‹ ì¸íŠ¸ë¡œ</div>
        <div class="row">
          <button id="introMuteBtn" class="small">ìŒì†Œê±° í•´ì œ</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="startFlash" class="startFlash" aria-hidden="true"></div>
<div id="guideOverlay" class="guideOverlay" aria-hidden="true">
  <div class="introContent">
    <div class="guideCard">
      <div class="guideTitle">ê²Œì„ ì§„í–‰ ë°©ë²•</div>
      <div id="guideBody" class="guideBody"></div>
      <div class="guideActions">
        <button id="guideCloseBtn" class="primary">í™•ì¸</button>
      </div>
    </div>
  </div>
</div>
<div id="endingOverlay" class="endingOverlay" aria-hidden="true">
  <div class="endingContent">
    <div class="endingCard">
      <div class="endingTitle">ê²Œì„ ì¢…ë£Œ</div>
      <div class="endingArt" aria-hidden="true"></div>
      <div id="endingText" class="endingDesc"></div>
      <div class="endingActions">
        <button id="endingRestartBtn" class="primary">ìƒˆ ê²Œì„ ì‹œì‘</button>
      </div>
    </div>
  </div>
</div>
<header>
  <div>
    <h1>ê¸ˆë¦¬ ê²Œì„ (ì—°ì¤€ ì˜ì¥ ì‹œë®¬ë ˆì´í„°) Â· HTML Prototype</h1>
    <div class="sub">
      ëª©í‘œ: ë¬¼ê°€(CPI)Â·ì‹¤ì—…ë¥ ì„ ì•ˆì •ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë©´ì„œ ê¸ˆìœµìœ„ê¸°ë¥¼ í”¼í•˜ê³  ë¯¼ì‹¬ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.<br/>
      ì „ìŸ/íŒ¬ë°ë¯¹/ê³µê¸‰ì¶©ê²©/ë²„ë¸”/ì‹ ìš©ê²½ìƒ‰/íŒŒì—… ì´ë²¤íŠ¸ê°€ ì¡°ê±´Â·í™•ë¥ ë¡œ ë°œìƒí•©ë‹ˆë‹¤.
    </div>
  </div>
  <div class="row">
    <span class="pill">í„´: <b id="month">1</b> / <span id="maxMonths">48</span>ê°œì›”</span>
    <span class="pill">ë‚œì´ë„: <b id="difficultyLabel">ë³´í†µ</b></span>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Controls + log -->
    <div class="card">
      <div class="split">
        <div>
        <div class="pill">ê¸°ì¤€ê¸ˆë¦¬ r: <b id="rateVal" class="mono rateVal">4.00%</b></div>
        </div>
        <div class="pill">ì‹ ë¢°ë„: <b id="credVal">70</b></div>
      </div>

      <div class="controls">
        <label>
          ë‚œì´ë„
          <select id="difficulty">
            <option value="easy" selected>ì‰¬ì›€</option>
            <option value="normal">ë³´í†µ</option>
            <option value="hard">í•˜ë“œ</option>
          </select>
        </label>

        <div class="btnRow">
          <button class="small" data-delta="-0.75">-0.75</button>
          <button class="small" data-delta="-0.50">-0.50</button>
          <button class="small" data-delta="-0.25">-0.25</button>
          <button class="small" data-delta="+0.25">+0.25</button>
          <button class="small" data-delta="+0.50">+0.50</button>
          <button class="small" data-delta="+0.75">+0.75</button>
        </div>

        <div class="split">
          <button id="nextBtn" class="primary">ë‹¤ìŒ ë‹¬ ì§„í–‰</button>
          <button id="autoBtn">ìë™ ì§„í–‰(10ê°œì›”)</button>
        </div>

        <div class="btnRow">
          <button id="resetBtn" class="danger">ìƒˆ ê²Œì„</button>
          <button id="guideBtn">ê²Œì„ ì§„í–‰ ë°©ë²•</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="split">
        <div class="pill">ìµœê·¼ ì´ë²¤íŠ¸/ë¦¬ì•¡ì…˜</div>
        <div class="pill">ì •ì±… ë³€í™”: <b id="lastDelta" class="mono">+0.00</b></div>
      </div>
      <div id="log" class="log" aria-live="polite"></div>

      <div class="footerNote">
        íŒ: CPIê°€ 6%ë¥¼ ë„˜ìœ¼ë©´ â€œê¸°ëŒ€ ì¸í”Œë ˆâ€ê°€ í’€ë¦¬ë©´ì„œ ë¬¼ê°€ê°€ ë” ëˆì í•´ì§‘ë‹ˆë‹¤(ì¡ê¸° ì–´ë ¤ì›€).<br/>
        ë²„ë¸” êµ¬ê°„ì—ì„œëŠ” ê¸ˆë¦¬ë¥¼ ë” ë‚´ë¦¬ë©´ ê³ ìš©ì´ ì•„ë‹ˆë¼ ìì‚°ë§Œ ë” ì˜¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- RIGHT: KPIs + chart -->
    <div class="card">
      <div class="row">
        <span class="pill">CPI ëª©í‘œ <b>2.0%</b></span>
        <span class="pill">ì¤‘ë¦½ê¸ˆë¦¬ <b>2.5%</b></span>
        <span class="pill">ì—”ë”© ì¡°ê±´: CPIâ‰¥18 ì§€ì† / ì‹¤ì—…â‰¥16 ì§€ì† / F=100 / ë¯¼ì‹¬ ë¶•ê´´</span>
      </div>

      <div class="kpiGrid" id="kpis"></div>

      <div class="divider"></div>

      <div class="chartTitle">
        <div class="pill">ìµœê·¼ 24ê°œì›” ì¶”ì´ (CPI / ì‹¤ì—…ë¥  / ìì‚°ì§€ìˆ˜)</div>
        <div class="pill">í‘œì‹œ: <b id="chartScale" class="mono">auto</b></div>
      </div>
      <div id="chartWrap">
        <canvas id="chart" width="980" height="280"></canvas>
      </div>

      <div class="footerNote">
        ì°¨íŠ¸ëŠ” ë‹¨ìˆœ ì„ í˜• ìŠ¤ì¼€ì¼ì…ë‹ˆë‹¤. (ìì‚°ì§€ìˆ˜ëŠ” ìŠ¤ì¼€ì¼ì´ ì»¤ì„œ í•¨ê»˜ í‘œì‹œí•  ë•Œ ìë™ ì •ê·œí™”ë©ë‹ˆë‹¤.)
      </div>
    </div>
  </div>
</div>

<script>
/** -------------------------
 *  RNG (seedable)
 * --------------------------*/
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function sgn(x){ return x < 0 ? -1 : (x > 0 ? 1 : 0); }

/** -------------------------
 *  Game State
 * --------------------------*/
const PARAMS = {
  targetCPI: 2.0,
  neutralRate: 2.5,
};

function defaultState(){
  return {
    month: 1,
    maxMonths: 48,
    r: 4.0,

    cpi: 3.0,
    u: 4.5,
    g: 1.5,
    a: 120.0,
    e: 2.6,
    f: 25.0,

    approval: 60.0,
    unrest: 10.0,
    credibility: 70.0,

    debt: 55.0,
    spec: 20.0,
    inequality: 40.0,

    supplyShock: 0.0,
    demandShock: 0.0,
    fearShock: 0.0,
    warIntensity: 0.0,
    pandemicIntensity: 0.0,

    lagRealRate: 0.0,
    lagTightness: 0.0,

    cpiHist: [3.0],
    uHist: [4.5],
    aHist: [120.0],

    lastRateChange: 0.0,
    lastDirection: 0,
    fHigh: false,
    cpiHigh8: false,
    luxHeat: false,
    uHigh9: false,
    stagFlag: false,
    unrestHigh70: false,
    warHigh40: false,
    pandemicHigh40: false
  };
}

let state = defaultState();

/** -------------------------
 * Difficulty (changes event rates & sensitivities)
 * --------------------------*/
const DIFF = {
  easy:   { eventMult: 0.68, shockMult: 0.80, approvalSensitivity: 0.85 },
  normal: { eventMult: 0.90, shockMult: 0.92, approvalSensitivity: 1.00 },
  hard:   { eventMult: 1.15, shockMult: 1.10, approvalSensitivity: 1.20 },
};
let difficulty = "easy";

/** -------------------------
 * Events
 * --------------------------*/
function decayShocks(s){
  s.supplyShock *= 0.80;
  s.demandShock *= 0.75;
  s.fearShock   *= 0.80;
  s.warIntensity *= 0.88;
  s.pandemicIntensity *= 0.86;
}

function chance(p, rng){ return rng() < p; }
function clampProb(p){ return clamp(p, 0.0005, 0.10); }

function getEvents(){
  return [
    {
      key:"pandemic",
      headline:"ğŸ“° ê°ì—¼ë³‘ í™•ì‚°! ì´ë™ ì œí•œìœ¼ë¡œ ê³µê¸‰ì´ ì¤„ê³  ê²½ê¸°ê°€ ìœ„ì¶•ë©ë‹ˆë‹¤. â†’ ë¬¼ê°€â†‘ ì‹¤ì—…â†‘",
      weight: 1.2,
      can: (s, rng) => {
        let base = 0.012;
        base += 0.01 * (1 - s.credibility/100);
        base += 0.004 * (s.unrest/100);
        const m = s.month % 12;
        base += ([12,1,2].includes(m) ? 0.005 : 0);
        base -= 0.01 * (s.pandemicIntensity/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        const intensity = randBetween(35, 70, rng) * DIFF[difficulty].shockMult;
        s.pandemicIntensity = clamp(s.pandemicIntensity + intensity, 0, 100);
        s.fearShock += randBetween(8, 18, rng) * DIFF[difficulty].shockMult;
        s.supplyShock += randBetween(4, 10, rng) * DIFF[difficulty].shockMult;
        s.demandShock -= randBetween(6, 14, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(3, 8, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(1, 4, rng);
      }
    },
    {
      key:"war",
      headline:"ğŸ“° ì „ìŸ/ì¶©ëŒ ê²©í™”! ì›ìì¬Â·ì—ë„ˆì§€ ê°€ê²© ê¸‰ë“±. â†’ ë¬¼ê°€â†‘ ê²½ê¸°â†“",
      weight: 1.2,
      can: (s, rng) => {
        let base = 0.010;
        base += 0.010 * (s.cpi/10);
        base += 0.004 * (s.f/100);
        base -= 0.01 * (s.warIntensity/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        const intensity = randBetween(40, 85, rng) * DIFF[difficulty].shockMult;
        s.warIntensity = clamp(s.warIntensity + intensity, 0, 100);
        s.supplyShock += randBetween(10, 22, rng) * DIFF[difficulty].shockMult;
        s.fearShock += randBetween(6, 16, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 6, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(2, 6, rng);
      }
    },
    {
      key:"supply",
      headline:"ğŸ“° ë¬¼ë¥˜Â·ì›ìì¬ ë¬¸ì œ! ë¬¼ê±´ì´ ë¶€ì¡±í•´ì§‘ë‹ˆë‹¤. â†’ ë¬¼ê°€â†‘",
      weight: 1.0,
      can: (s, rng) => {
        let base = 0.015 + 0.01*(s.cpi/8);
        base += 0.006*(s.fearShock/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        s.supplyShock += randBetween(6, 14, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(1, 4, rng) * DIFF[difficulty].approvalSensitivity;
      }
    },
    {
      key:"bubble",
      headline:"ğŸ“° ë¹šíˆ¬Â·ì˜ëŒ ê³¼ì—´! ìì‚° ê°€ê²©ì´ ê¸‰ë“±í•©ë‹ˆë‹¤. â†’ ë²„ë¸” ìœ„í—˜â†‘ ê¸ˆìœµë¶ˆì•ˆâ†‘",
      weight: 1.1,
      can: (s, rng) => {
        if(s.a < 120) return false;
        const lookback = Math.min(6, s.aHist.length);
        const trend = lookback >= 2 ? (s.aHist[s.aHist.length-1] - s.aHist[s.aHist.length-lookback]) : 0;
        let base = 0.01;
        base += 0.015 * (Math.max(0, 3.0 - s.r) / 3.0);
        base += 0.02 * clamp(trend/30, 0, 1);
        base += 0.01 * (s.spec/100);
        base += 0.006 * (Math.max(0, s.a - 150)/150);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        s.spec = clamp(s.spec + randBetween(10, 25, rng), 0, 100);
        s.inequality = clamp(s.inequality + randBetween(3, 10, rng), 0, 100);
        s.approval -= randBetween(1, 5, rng) * DIFF[difficulty].approvalSensitivity;
        s.a += randBetween(8, 20, rng);
      }
    },
    {
      key:"crunch",
      headline:"ğŸ“° ëˆì´ ëŒì§€ ì•ŠìŒ! ê¸°ì—…ì´ ìê¸ˆ ì¡°ë‹¬ì´ ì–´ë ¤ì›Œì§. â†’ ê²½ê¸°â†“ ì‹¤ì—…â†‘",
      weight: 1.0,
      can: (s, rng) => {
        let base = 0.006;
        base += 0.02*(s.f/100);
        base += 0.012*(Math.abs(s.lastRateChange)/1.0);
        base += 0.01*(s.debt/100);
        base += 0.008*(s.fearShock/100);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        s.f = clamp(s.f + randBetween(15, 30, rng) * DIFF[difficulty].shockMult, 0, 100);
        s.fearShock += randBetween(10, 20, rng) * DIFF[difficulty].shockMult;
        s.demandShock -= randBetween(6, 12, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 6, rng) * DIFF[difficulty].approvalSensitivity;
        s.unrest += randBetween(2, 6, rng);
      }
    },
    {
      key:"strike",
      headline:"ğŸ“° ëŒ€ê·œëª¨ íŒŒì—…! ìƒì‚°ì´ ì¤„ê³  ë¬¼ê±´ì´ ë¶€ì¡±í•´ì§‘ë‹ˆë‹¤. â†’ ë¬¼ê°€â†‘ ë¯¼ì‹¬â†“",
      weight: 0.9,
      can: (s, rng) => {
        let base = 0.008;
        base += 0.02 * (Math.max(0, s.cpi - 4.0)/6.0);
        base += 0.02 * (s.unrest/100);
        base += 0.008 * (s.u/12);
        base *= DIFF[difficulty].eventMult;
        return chance(clampProb(base), rng);
      },
      apply: (s, rng) => {
        s.unrest = clamp(s.unrest + randBetween(8, 18, rng), 0, 100);
        s.supplyShock += randBetween(3, 8, rng) * DIFF[difficulty].shockMult;
        s.approval -= randBetween(2, 5, rng) * DIFF[difficulty].approvalSensitivity;
      }
    },
  ];
}

function randBetween(a,b,rng){ return a + (b-a)*rng(); }
function randBetweenScaled(a,b,scale,rng){
  return a + (b-a)*rng()*scale + (b-a)*(1-scale)*0.5;
}

function weightedPick(cands, rng){
  const total = cands.reduce((acc, ev) => acc + (ev.weight || 1), 0);
  let r = rng() * total;
  for(const ev of cands){
    r -= (ev.weight || 1);
    if(r <= 0) return ev;
  }
  return cands[cands.length-1];
}

function maybeEvents(s, rng){
  const events = getEvents();
  const triggered = [];
  const cands1 = events.filter(ev => ev.can(s, rng));
  if(cands1.length){
    const ev = weightedPick(cands1, rng);
    ev.apply(s, rng);
    triggered.push(ev.headline);
  }
  if(rng() < 0.18 * DIFF[difficulty].eventMult){
    const cands2 = events.filter(ev => ev.can(s, rng));
    if(cands2.length){
      const ev2 = weightedPick(cands2, rng);
      ev2.apply(s, rng);
      triggered.push(ev2.headline);
    }
  }
  return triggered;
}

/** -------------------------
 * Simulation step (1 month)
 * --------------------------*/
function stepMonth(s, rng){
  const logs = [];
  decayShocks(s);
  const randScale = s.month <= 4 ? 0.5 : 1.0;

  const realRate = s.r - s.e;
  s.lagRealRate = 0.60*s.lagRealRate + 0.40*realRate;
  const tightness = s.r - PARAMS.neutralRate;
  s.lagTightness = 0.50*s.lagTightness + 0.50*tightness;

  const warDrag = 0.03*(s.warIntensity/10);
  const pandDrag = 0.04*(s.pandemicIntensity/10);

  // growth
  let g = s.g;
  g += 0.55*(PARAMS.neutralRate - s.lagRealRate);
  g -= 0.02*s.f;
  g -= 0.10*(s.supplyShock/10);
  g += 0.08*(s.demandShock/10);
  g -= warDrag;
  g -= pandDrag;
  g += randBetweenScaled(-0.4, 0.4, randScale, rng);
  g = clamp(g, -10, 8);

  // unemployment
  let u = s.u;
  u += 0.18*(-g);
  u += 0.02*(s.f/10);
  u += 0.05*(s.pandemicIntensity/20);
  u += randBetweenScaled(-0.1, 0.1, randScale, rng);
  u = clamp(u, 2.0, 20.0);

  // CPI
  let cpi = s.cpi;
  cpi += 0.10*Math.max(0, g);
  cpi += 0.08*(s.e - PARAMS.targetCPI);
  cpi -= 0.22*(s.lagTightness);
  if(s.lagRealRate > 0.8) cpi -= 0.10*(s.lagRealRate - 0.8);
  cpi += 0.26*(s.supplyShock/10);
  cpi += 0.10*(s.warIntensity/20);

  // nonlinearity / stickiness
  if(cpi > 6) cpi += 0.04*(cpi-6);
  if(cpi > 10) cpi += 0.06*(cpi-10);

  cpi += randBetweenScaled(-0.15, 0.15, randScale, rng);
  cpi = clamp(cpi, -1.0, 25.0);

  // expected inflation
  let credDamp = (1.0 - s.credibility/150);
  let e = s.e;
  e += 0.20*(cpi - PARAMS.targetCPI)*credDamp;

  // direction change penalty (flip-flop)
  const dir = sgn(s.lastRateChange);
  if(s.lastDirection !== 0 && dir !== 0 && dir !== s.lastDirection){
    e += 0.25;
    s.credibility -= 2.0;
    logs.push("âš ï¸ ì •ì±… ë°©í–¥ ê¸‰ë³€ìœ¼ë¡œ ì‹ ë¢°ë„ í•˜ë½");
  }

  if(cpi >= 8) s.credibility -= 1.5;
  s.credibility = clamp(s.credibility, 0, 100);
  e = clamp(e, 0, 15);

  // assets
  let a = s.a;
  a += 3.2*(PARAMS.neutralRate - s.r);
  a += 0.25*(s.spec/10);
  a -= 0.30*(s.fearShock/5);
  a -= 0.25*(s.f/10);

  // crash risk
  let crashProb = 0;
  crashProb += 0.002*Math.max(0, s.f - 65);
  crashProb += 0.01*Math.max(0, Math.abs(s.lastRateChange) - 0.5);
  crashProb += 0.006*Math.max(0, s.spec - 70)/10;
  crashProb = clamp(crashProb, 0, 0.35);

  if(rng() < crashProb){
  const drop = randBetween(18, 45, rng);
    a -= drop;
    s.fearShock += randBetween(10, 20, rng);
    s.f = clamp(s.f + randBetween(8, 16, rng), 0, 100);
    s.unrest = clamp(s.unrest + randBetween(5, 12, rng), 0, 100);
    logs.push(`ğŸ“‰ ìì‚°ì‹œì¥ ê¸‰ë½(ë²„ë¸” ë¶•ê´´) -${drop.toFixed(1)}`);
  }

  a += randBetweenScaled(-2, 2, randScale, rng);
  a = clamp(a, 50, 300);

  // financial stress
  let f = s.f;
  f += 6.0*Math.abs(s.lastRateChange);
  f += 0.25*(s.debt/10);
  f += 0.20*Math.max(0, (a - 150)/10);
  f += 0.35*(s.fearShock/10);
  f -= 0.45*Math.max(0, s.r - PARAMS.neutralRate);
  f -= 0.20*(s.lagRealRate);
  f += randBetweenScaled(-1.5, 1.5, randScale, rng);
  f = clamp(f, 0, 100);

  // speculation & debt
  let spec = s.spec;
  const trendA = (a - s.a);
  spec += 0.20*Math.max(0, (PARAMS.neutralRate - s.r))*10;
  spec += 0.08*Math.max(0, trendA);
  spec -= 0.10*(f/10);
  spec += randBetweenScaled(-1.5, 1.5, randScale, rng);
  spec = clamp(spec, 0, 100);

  let debt = s.debt;
  debt += 0.16*Math.max(0, (PARAMS.neutralRate - s.r))*10;
  debt += 0.06*Math.max(0, g);
  debt -= 0.10*Math.max(0, (f - 60)/10);
  debt += randBetweenScaled(-0.9, 0.9, randScale, rng);
  debt = clamp(debt, 0, 100);

  // inequality
  let ineq = s.inequality;
  ineq += 0.06*Math.max(0, (a - 140)/10);
  ineq += 0.04*Math.max(0, (cpi - 3.0));
  ineq += 0.10*Math.max(0, (u - 6.0));
  ineq += randBetweenScaled(-0.7, 0.7, randScale, rng);
  ineq = clamp(ineq, 0, 100);

  // approval & unrest
  let approval = s.approval;
  const sens = DIFF[difficulty].approvalSensitivity;
  approval -= sens * 1.3*Math.max(0, (cpi - 3.0));
  approval -= sens * 1.0*Math.max(0, (u - 5.0));
  approval += 0.03*Math.max(0, (a - 120));
  approval -= 0.06*(ineq/10);
  approval += 0.03*(s.credibility - 60);
  approval += randBetweenScaled(-1.5, 1.5, randScale, rng);
  approval = clamp(approval, 0, 100);

  let unrest = s.unrest;
  unrest += 0.8*Math.max(0, (cpi - 4.0));
  unrest += 0.9*Math.max(0, (u - 6.0));
  unrest += 0.4*Math.max(0, (ineq - 50)/10);
  unrest += 0.2*Math.max(0, (f - 70)/10);
  unrest -= 0.25*Math.max(0, (approval - 55)/10);
  unrest += randBetweenScaled(-1.0, 1.0, randScale, rng);
  unrest = clamp(unrest, 0, 100);

  // write back
  s.g=g; s.u=u; s.cpi=cpi; s.e=e; s.a=a; s.f=f;
  s.spec=spec; s.debt=debt; s.inequality=ineq;
  s.approval=approval; s.unrest=unrest;

  // histories
  s.cpiHist.push(s.cpi);
  s.uHist.push(s.u);
  s.aHist.push(s.a);
  if(s.cpiHist.length > 24){
    s.cpiHist = s.cpiHist.slice(-24);
    s.uHist = s.uHist.slice(-24);
    s.aHist = s.aHist.slice(-24);
  }

  return logs;
}

/** -------------------------
 * Endings & reactions
 * --------------------------*/
function checkEnding(s){
  const last3cpi = s.cpiHist.slice(-3);
  const last3u = s.uHist.slice(-3);
  if(s.cpi >= 18 && last3cpi.length===3 && last3cpi.every(x=>x>=18)) return "ğŸ’¥ ì—”ë”©: ë¬¼ê°€ í­ë“±(í†µì œ ë¶ˆëŠ¥) â€” ì¤‘ì•™ì€í–‰ ì‹ ë¢° ë¶•ê´´";
  if(s.u >= 16 && last3u.length===3 && last3u.every(x=>x>=16)) return "ğŸ•³ï¸ ì—”ë”©: ëŒ€ê³µí™© â€” ì‹¤ì—…ë¥  ì¥ê¸° ê³ ì°©";
  if(s.f >= 100) return "ğŸ¦ ì—”ë”©: ê¸ˆìœµì‹œìŠ¤í…œ ë¶•ê´´ â€” ì‹ ìš© ê²½ìƒ‰ìœ¼ë¡œ ê²½ì œ ì •ì§€";
  if(s.approval <= 2 && s.unrest >= 95) return "ğŸ”¥ ì—”ë”©: ì‚¬íšŒ ë¶ˆì•ˆ í­ë°œ â€” ì •ì±… ì§€ì† ë¶ˆê°€ëŠ¥";
  if(s.month > s.maxMonths){
    return "ğŸ ì—”ë”©: ëª…ì˜ˆë¡œìš´ í‡´ì§„ â€” ì„ê¸°ë¥¼ ë¬´ì‚¬íˆ ë§ˆì³¤ìŠµë‹ˆë‹¤.";
  }
  return null;
}

function failureInfo(ending, s){
  if(!ending || ending.startsWith("ğŸ")) return null;
  const lines = [];
  if(ending.includes("ë¬¼ê°€ í­ë“±")){
    lines.push("ì‹¤íŒ¨ ì§€í‘œ: CPI(ë¬¼ê°€) í­ë“±");
    lines.push("ì›ì¸: ê³µê¸‰ì¶©ê²©Â·ì „ìŸ ì¶©ê²© + ê¸°ëŒ€ì¸í”Œë ˆ ìƒìŠ¹");
    lines.push("íŒ: ì¶©ê²© ë°œìƒ ì‹œ ê¸ˆë¦¬ë¥¼ ë¹ ë¥´ê²Œ ì˜¬ë¦¬ê³ (0.25~0.5) ìœ ì§€í•´ ê¸°ëŒ€ì¸í”Œë ˆë¥¼ ê³ ì •");
  } else if(ending.includes("ëŒ€ê³µí™©")){
    lines.push("ì‹¤íŒ¨ ì§€í‘œ: ì‹¤ì—…ë¥  ì¥ê¸° ê³ ì°©");
    lines.push("ì›ì¸: ì„±ì¥ë¥  ë‘”í™” ì§€ì† + ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤Â·ê³µí¬ì¶©ê²©");
    lines.push("íŒ: ê¸‰ê²©í•œ ê¸´ì¶•ì„ í”¼í•˜ê³ , ì™„í™” í›„ 2~3í„´ ìœ ì§€ë¡œ ì„±ì¥ íšŒë³µ");
  } else if(ending.includes("ê¸ˆìœµì‹œìŠ¤í…œ")){
    lines.push("ì‹¤íŒ¨ ì§€í‘œ: ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤(F) 100 ë„ë‹¬");
    lines.push("ì›ì¸: í° í­ ê¸ˆë¦¬ ë³€ë™ + ë¶€ì±„/ìì‚° ê³¼ì—´ + ê³µí¬ì¶©ê²©");
    lines.push("íŒ: ê¸ˆë¦¬ ë³€ê²½ í­ì„ ì¤„ì´ê³ (Â±0.25), ë³€ë™ ê°„ê²©ì„ ëŠ˜ë ¤ ì•ˆì •í™”");
  } else if(ending.includes("ì‚¬íšŒ ë¶ˆì•ˆ")){
    lines.push("ì‹¤íŒ¨ ì§€í‘œ: ë¯¼ì‹¬ ë¶•ê´´ + ì‚¬íšŒë¶ˆì•ˆ í­ë°œ");
    lines.push("ì›ì¸: ë¬¼ê°€Â·ì‹¤ì—… ë™ì‹œ ì•…í™” + ë¶ˆí‰ë“±Â·ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ ëˆ„ì ");
    lines.push("íŒ: CPI 6 ì´ìƒ êµ¬ê°„ì„ ë¹ ë¥´ê²Œ ë²—ì–´ë‚˜ê³ , ì‹¤ì—… ê¸‰ë“± ì‹œ ì™„í™”ë¡œ ì „í™˜");
  }
  return lines.length ? lines : null;
}

function reactions(s){
  const out = [];
  const luxCond = s.cpi >= 7 && s.a >= 160 && s.u <= 6;
  const basketCond = s.cpi >= 8;
  const uCond = s.u >= 9;
  const stagCond = s.cpi >= 7 && s.g <= -0.2 && s.u >= 7.5;
  const fCond = s.f >= 75;
  const unrestCond = s.unrest >= 70;
  const warCond = s.warIntensity >= 40;
  const panCond = s.pandemicIntensity >= 40;

  if(luxCond && !s.luxHeat) out.push("ğŸ‘œ ê±°ë¦¬: â€˜ëª…í’ˆ ì˜¤í”ˆëŸ°â€™â€¦ ì²´ê°ë¬¼ê°€ëŠ” ì˜¤ë¥´ëŠ”ë° ê³¼ì‹œ ì†Œë¹„ê°€ ê³¼ì—´ë©ë‹ˆë‹¤.");
  if(basketCond && !s.cpiHigh8) out.push("ğŸ§¾ ì‹œë¯¼: â€˜ì¥ë°”êµ¬ë‹ˆê°€ ë¬´ì„­ë‹¤â€™â€¦ ìƒí•„í’ˆ ê°€ê²© ê¸‰ë“±ì— í•­ì˜ê°€ ì»¤ì§‘ë‹ˆë‹¤.");
  if(uCond && !s.uHigh9) out.push("ğŸª§ ë…¸ë™: í•´ê³  í™•ì‚°â€¦ ì‹œìœ„Â·íŒŒì—… ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.");
  if(stagCond && !s.stagFlag) out.push("âš ï¸ ê²½ê³ : ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜ ì§•í›„(ë¬¼ê°€â†‘ ê²½ê¸°â†“ ì‹¤ì—…â†‘).");
  if(fCond && !s.fHigh) out.push("ğŸ¦ ì‹œì¥: â€˜ëˆì´ ë§ˆë¥¸ë‹¤â€™â€¦ ê¸ˆìœµ ê²½ìƒ‰ì´ ì‹¤ë¬¼ê²½ì œë¡œ ë²ˆì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  if(unrestCond && !s.unrestHigh70) out.push("ğŸ”¥ ì‚¬íšŒ: ëŒ€ê·œëª¨ ì§‘íšŒ ì¡°ì§â€¦ ì •ì¹˜ê¶Œ ì••ë°•ì´ í¬ê²Œ ì¦ê°€í•©ë‹ˆë‹¤.");
  if(warCond && !s.warHigh40) out.push("ğŸª– ì§€ì •í•™: ì „ìŸ ë¦¬ìŠ¤í¬ ì§€ì†â€¦ ì—ë„ˆì§€Â·ì›ìì¬ ê²½ë¡œë¡œ ë¬¼ê°€ ì••ë°•ì´ ê¸¸ì–´ì§‘ë‹ˆë‹¤.");
  if(panCond && !s.pandemicHigh40) out.push("ğŸ¦  ë³´ê±´: íŒ¬ë°ë¯¹ ì—¬íŒŒ ì§€ì†â€¦ ê³ ìš© íšŒë³µì´ ë”ë”œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

  s.luxHeat = luxCond;
  s.cpiHigh8 = basketCond;
  s.uHigh9 = uCond;
  s.stagFlag = stagCond;
  s.fHigh = fCond;
  s.unrestHigh70 = unrestCond;
  s.warHigh40 = warCond;
  s.pandemicHigh40 = panCond;
  return out;
}

function situationTip(s){
  if(s.cpi >= 10) return "ğŸ’¡ íŒ: ë¬¼ê°€ê°€ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. 0.5 ì¸ìƒ í›„ 2~3í„´ ìœ ì§€ë¡œ ê¸°ëŒ€ì¸í”Œë ˆë¥¼ ë¨¼ì € ëˆŒëŸ¬ë³´ì„¸ìš”.";
  if(s.u >= 12) return "ğŸ’¡ íŒ: ì‹¤ì—…ì´ ì‹¬ê°í•©ë‹ˆë‹¤. ì¶”ê°€ ê¸´ì¶•ì„ í”¼í•˜ê³  ì™„í™” í›„ ëª‡ í„´ ìœ ì§€í•˜ì„¸ìš”.";
  if(s.f >= 85) return "ğŸ’¡ íŒ: ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ê¸ˆë¦¬ ë³€ë™ í­ì„ ì¤„ì´ê³  ì•ˆì • êµ¬ê°„ì„ í™•ë³´í•˜ì„¸ìš”.";
  if(s.unrest >= 85 && s.approval <= 20) return "ğŸ’¡ íŒ: ì‚¬íšŒë¶ˆì•ˆì´ ì„ê³„ì¹˜ì— ê°€ê¹ìŠµë‹ˆë‹¤. CPI 6 ì´ìƒ êµ¬ê°„ì„ ë¹ ë¥´ê²Œ íƒˆì¶œí•˜ì„¸ìš”.";
  if(s.cpi >= 7 && s.g <= -0.5 && s.u >= 9) return "ğŸ’¡ íŒ: ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜ ìœ„í—˜. ê³¼ë„í•œ ê¸´ì¶•ì€ ì‹¤ì—…ì„ í‚¤ìš°ë‹ˆ ë‹¨ê³„ì  ëŒ€ì‘ì´ ì•ˆì „í•©ë‹ˆë‹¤.";
  return "";
}

/** -------------------------
 * UI rendering
 * --------------------------*/
const el = (id)=>document.getElementById(id);
const logEl = el("log");
const kpisEl = el("kpis");
const chart = el("chart");
const ctx = chart.getContext("2d");
const endingOverlay = el("endingOverlay");
const endingText = el("endingText");
const endingRestartBtn = el("endingRestartBtn");
const startOverlay = el("startOverlay");
const startBtn = el("startBtn");
const introOverlay = el("introOverlay");
const introVideo = el("introVideo");
const introMuteBtn = el("introMuteBtn");
const startFlash = el("startFlash");
const guideOverlay = el("guideOverlay");
const guideBody = el("guideBody");
const guideCloseBtn = el("guideCloseBtn");
const guideBtn = el("guideBtn");

function fmt(x, d=2){ return Number(x).toFixed(d); }
function kpiColor(label, v){
  // simple threshold coloring
  if(label==="CPI"){
    if(v<=3.5) return "good";
    if(v<=6.0) return "warn";
    return "bad";
  }
  if(label==="ì‹¤ì—…ë¥ "){
    if(v<=6.0) return "good";
    if(v<=9.0) return "warn";
    return "bad";
  }
  if(label==="ì„±ì¥ë¥ "){
    if(v>=1.0) return "good";
    if(v>=0.0) return "warn";
    return "bad";
  }
  if(label==="ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤"){
    if(v<55) return "good";
    if(v<75) return "warn";
    return "bad";
  }
  if(label==="ë¯¼ì‹¬"){
    if(v>=55) return "good";
    if(v>=35) return "warn";
    return "bad";
  }
  if(label==="ì‚¬íšŒë¶ˆì•ˆ"){
    if(v<35) return "good";
    if(v<70) return "warn";
    return "bad";
  }
  // default
  return v >= 0 ? "warn" : "bad";
}

function renderKPIs(){
  const items = [
    {label:"CPI", val: state.cpi, unit:"% YoY", hint:"ë¬¼ê°€", tip:"ë¬¼ê°€ ìƒìŠ¹ë¥ . 18 ì´ìƒì´ 3ê°œì›” ì§€ì†ë˜ë©´ ì‹¤íŒ¨."},
    {label:"ì‹¤ì—…ë¥ ", val: state.u, unit:"%", hint:"ê³ ìš©", tip:"ì‹¤ì—…ë¥ . 16 ì´ìƒì´ 3ê°œì›” ì§€ì†ë˜ë©´ ì‹¤íŒ¨."},
    {label:"ì„±ì¥ë¥ ", val: state.g, unit:"%", hint:"ê²½ê¸°", tip:"ê²½ê¸° ì„±ì¥ë¥ . ë‚®ì„ìˆ˜ë¡ ì‹¤ì—…ì´ ì˜¤ë¥´ê³  ë¯¼ì‹¬ì´ ì•½í•´ì§."},
    {label:"ìì‚°ì§€ìˆ˜", val: state.a, unit:"index", hint:"ì£¼ì‹+ë¶€ë™ì‚°(í•©ì„±)", tip:"ìì‚°ê°€ê²© ì§€ìˆ˜. ê³¼ì—´ ì‹œ ë²„ë¸”Â·ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ ìœ„í—˜ ìƒìŠ¹."},
    {label:"ê¸°ëŒ€ì¸í”Œë ˆ", val: state.e, unit:"%", hint:"ì‹¬ë¦¬/ê¸°ëŒ€", tip:"ì•ìœ¼ë¡œì˜ ë¬¼ê°€ ê¸°ëŒ€. ë†’ì•„ì§€ë©´ CPIë¥¼ ë°€ì–´ì˜¬ë¦¼."},
    {label:"ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤", val: state.f, unit:"/100", hint:"ìœ„ê¸° ë¦¬ìŠ¤í¬", tip:"ê¸ˆìœµì‹œì¥ ë¶ˆì•ˆ. ê¸ˆë¦¬ë¥¼ ìì£¼/í¬ê²Œ ë°”ê¿€ìˆ˜ë¡, ë¶€ì±„Â·ìì‚° ê³¼ì—´Â·ê³µí¬ì¶©ê²©ì´ ë†’ì„ìˆ˜ë¡ ìƒìŠ¹. 100 ë„ë‹¬ ì‹œ ì¦‰ì‹œ ì‹¤íŒ¨."},
    {label:"ë¯¼ì‹¬", val: state.approval, unit:"/100", hint:"ì§€ì§€ìœ¨", tip:"ì •ì±… ì§€ì§€ë„. 2 ì´í•˜ + ì‚¬íšŒë¶ˆì•ˆ 95 ì´ìƒì´ë©´ ì‹¤íŒ¨."},
    {label:"ì‚¬íšŒë¶ˆì•ˆ", val: state.unrest, unit:"/100", hint:"ì‹œìœ„/íŒŒì—…", tip:"ì‚¬íšŒ ê°ˆë“±. ë¯¼ì‹¬ 2 ì´í•˜ì™€ í•¨ê»˜ 95 ì´ìƒì´ë©´ ì‹¤íŒ¨."},
  ];
  kpisEl.innerHTML = items.map(it=>{
    const cls = kpiColor(it.label, it.val);
    return `
      <div class="kpi" data-tip="${it.tip}">
        <div class="label">${it.label} <span class="mono" style="color:var(--muted)">(${it.unit})</span></div>
        <div class="val ${cls}">${fmt(it.val, it.label==="ìì‚°ì§€ìˆ˜"?1:2)}</div>
        <div class="hint">${it.hint}</div>
      </div>
    `;
  }).join("");
}

function pushLog(lines, type=""){
  const frag = document.createDocumentFragment();
  for(const line of lines){
    const p = document.createElement("p");
    if(type) p.className = type;
    p.innerHTML = line;
    frag.appendChild(p);
  }
  logEl.appendChild(frag);
  logEl.scrollTop = logEl.scrollHeight;
}

function clearLog(){
  logEl.innerHTML = "";
}

function renderTop(){
  el("month").textContent = String(state.month);
  el("maxMonths").textContent = String(state.maxMonths);
  el("rateVal").textContent = `${fmt(state.r,2)}%`;
  el("credVal").textContent = `${Math.round(state.credibility)}`;
  el("lastDelta").textContent = `${(state.lastRateChange>=0?"+":"")}${fmt(state.lastRateChange,2)}`;
  el("difficultyLabel").textContent = difficulty==="easy" ? "ì‰¬ì›€" : (difficulty==="hard" ? "í•˜ë“œ" : "ë³´í†µ");
}

function drawChart(){
  // Basic line chart with normalization for asset index
  const w = chart.width, h = chart.height;
  ctx.clearRect(0,0,w,h);

  // frame
  ctx.globalAlpha = 1;
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  ctx.strokeRect(0.5,0.5,w-1,h-1);

  const padL=44, padR=12, padT=12, padB=24;
  const innerW = w - padL - padR;
  const innerH = h - padT - padB;

  const n = state.cpiHist.length;
  const xs = (i)=> padL + (innerW * (n<=1 ? 0 : i/(n-1)));
  const y = (v, vmin, vmax)=>{
    const t = (v - vmin) / (vmax - vmin || 1);
    return padT + (1 - t)*innerH;
  };

  // ranges
  const cpiMin = Math.min(...state.cpiHist, 0);
  const cpiMax = Math.max(...state.cpiHist, 8);
  const uMin = Math.min(...state.uHist, 2);
  const uMax = Math.max(...state.uHist, 12);
  const aMin = Math.min(...state.aHist, 70);
  const aMax = Math.max(...state.aHist, 200);

  // normalize A to 0~1 for shared plot
  const normA = state.aHist.map(v => (v - aMin)/(aMax - aMin || 1));
  const normCPI = state.cpiHist.map(v => (v - cpiMin)/(cpiMax - cpiMin || 1));
  const normU = state.uHist.map(v => (v - uMin)/(uMax - uMin || 1));

  el("chartScale").textContent = "auto";

  // grid lines
  ctx.strokeStyle = "rgba(255,255,255,0.06)";
  for(let j=1;j<=4;j++){
    const yy = padT + (innerH*j/5);
    ctx.beginPath();
    ctx.moveTo(padL, yy);
    ctx.lineTo(padL+innerW, yy);
    ctx.stroke();
  }

  // legend (no colors requested? user did not forbid; but to keep simple, use different alpha/line patterns)
  ctx.fillStyle = "rgba(255,255,255,0.55)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("CPI", padL, h-8);
  ctx.fillText("U", padL+60, h-8);
  ctx.fillText("A(ì •ê·œí™”)", padL+105, h-8);

  // draw lines with varying alpha and dash
  function plot(arrNorm, dash, alpha){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.setLineDash(dash);
    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const xx = xs(i);
      const yy = padT + (1-arrNorm[i]) * innerH;
      if(i===0) ctx.moveTo(xx,yy);
      else ctx.lineTo(xx,yy);
    }
    ctx.stroke();
    ctx.restore();
  }
  plot(normCPI, [], 0.95);
  plot(normU, [6,4], 0.70);
  plot(normA, [2,4], 0.55);

  // y-axis labels (approx)
  ctx.fillStyle = "rgba(255,255,255,0.45)";
  ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif";
  ctx.fillText(`CPI ${cpiMin.toFixed(1)}~${cpiMax.toFixed(1)}`, 8, 22);
  ctx.fillText(`U ${uMin.toFixed(1)}~${uMax.toFixed(1)}`, 8, 38);
  ctx.fillText(`A ${aMin.toFixed(0)}~${aMax.toFixed(0)}`, 8, 54);

  // last point marker
  const lastX = xs(n-1);
  const lastY = padT + (1 - normCPI[n-1]) * innerH;
  ctx.beginPath();
  ctx.fillStyle = "rgba(125,211,252,0.9)";
  ctx.arc(lastX, lastY, 3.2, 0, Math.PI*2);
  ctx.fill();
}

function renderAll(){
  renderTop();
  renderKPIs();
  drawChart();
}

/** -------------------------
 * Sound
 * --------------------------*/
let audioCtx = null;
let audioUnlocked = false;
function ensureAudio(){
  if(audioUnlocked) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const buf = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.start(0);
    audioUnlocked = true;
  }catch(e){
    audioUnlocked = false;
  }
}

function playTone({freq=440, dur=0.18, type="sine", gain=0.06, slide=0, jitter=0, detune=0}){
  if(!audioUnlocked || !audioCtx) return;
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  const base = freq + (Math.random()*2-1)*jitter;
  osc.frequency.setValueAtTime(base, now);
  if(slide){
    osc.frequency.linearRampToValueAtTime(base + slide, now + dur);
  }
  if(detune) osc.detune.setValueAtTime(detune, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain), now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
  osc.connect(g);
  g.connect(audioCtx.destination);
  osc.start(now);
  osc.stop(now + dur + 0.05);
}

function playEventSound(line){
  const t = line || "";
  if(/ì „ìŸ|ì¶©ëŒ|ê¸ˆìœµì‹œì¥|ê²½ìƒ‰|ë¶•ê´´/.test(t)){
    playTone({freq:140, dur:0.28, type:"sawtooth", gain:0.08, slide:-40});
    playTone({freq:90, dur:0.22, type:"square", gain:0.05, slide:-20, detune:-20});
    return;
  }
  if(/íŒ¬ë°ë¯¹|ê°ì—¼ë³‘/.test(t)){
    playTone({freq:220, dur:0.32, type:"triangle", gain:0.06, slide:-80});
    return;
  }
  if(/ë²„ë¸”|ê³¼ì—´|ìì‚°/.test(t)){
    playTone({freq:520, dur:0.12, type:"sine", gain:0.05, slide:80});
    playTone({freq:720, dur:0.08, type:"sine", gain:0.03, slide:-40});
    return;
  }
  if(/íŒŒì—…|ë…¸ì¡°/.test(t)){
    playTone({freq:180, dur:0.22, type:"square", gain:0.06, slide:-30});
    return;
  }
  if(/ë¬¼ë¥˜|ì›ìì¬|ìƒí™œë¬¼ê°€/.test(t)){
    playTone({freq:260, dur:0.18, type:"triangle", gain:0.05, slide:-20});
    return;
  }
  playTone({freq:330, dur:0.16, type:"sine", gain:0.04});
}

function playReactionSound(line){
  const t = line || "";
  if(/ê²½ê³ |ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜/.test(t)){
    playTone({freq:420, dur:0.18, type:"triangle", gain:0.05, slide:-60});
    return;
  }
  if(/ì‚¬íšŒ|ì‹œìœ„|ë¶ˆì•ˆ|í­ë°œ/.test(t)){
    playTone({freq:160, dur:0.24, type:"sawtooth", gain:0.07, slide:-40});
    return;
  }
  if(/ì‹œì¥|ê¸ˆìœµ/.test(t)){
    playTone({freq:240, dur:0.18, type:"square", gain:0.05, slide:-20});
    return;
  }
  if(/ì‹œë¯¼|ì¥ë°”êµ¬ë‹ˆ|ë¬¼ê°€/.test(t)){
    playTone({freq:300, dur:0.14, type:"triangle", gain:0.04, slide:-10});
    return;
  }
  playTone({freq:360, dur:0.12, type:"sine", gain:0.035});
}

function playEndingSound(){
  playTone({freq:120, dur:0.35, type:"sawtooth", gain:0.09, slide:-80});
  setTimeout(()=>playTone({freq:90, dur:0.35, type:"square", gain:0.07, slide:-60}), 80);
  setTimeout(()=>playTone({freq:60, dur:0.4, type:"triangle", gain:0.06, slide:-40}), 160);
}

function playStartSound(){
  playTone({freq:520, dur:0.12, type:"sine", gain:0.05, slide:60});
  setTimeout(()=>playTone({freq:660, dur:0.12, type:"sine", gain:0.045, slide:40}), 60);
  setTimeout(()=>playTone({freq:880, dur:0.12, type:"triangle", gain:0.04, slide:20}), 120);
}

function showStartFlash(){
  if(!startFlash) return;
  startFlash.classList.add("show");
  setTimeout(()=>startFlash.classList.remove("show"), 480);
}

function showGuideOverlay(){
  if(!guideOverlay || !guideBody) return;
  guideBody.innerHTML = `
    <div class="guideGrid">
      <div>
        <div class="guideSectionTitle">ì§„í–‰ ë°©ë²•</div>
        - <b>ë§¤ í„´ì€ ê°€ìƒì˜ 1ë‹¬</b>ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë§¤ í„´ë§ˆë‹¤ ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ë¡œ ë¬¼ê°€Â·ì‹¤ì—… ë“± ì§€í‘œê°€ ê³„ì† ë³€í•©ë‹ˆë‹¤.<br/>
        - ê¸ˆë¦¬ë¥¼ ì¡°ì ˆí•´ ì„ê¸°(48ê°œì›”)ê°€ ëë‚  ë•Œê¹Œì§€ ë³€í™”ì— <b>ê¾¸ì¤€íˆ ëŒ€ì‘</b>í•´ì•¼ í•©ë‹ˆë‹¤.<br/><br/>
        1) ê¸ˆë¦¬ ì¡°ì ˆ ë²„íŠ¼(âˆ’0.75 ~ +0.75)ì„ ëˆŒëŸ¬ ê¸°ì¤€ê¸ˆë¦¬ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.<br/>
        2) <b>ë‹¤ìŒ ë‹¬ ì§„í–‰</b> ë²„íŠ¼ìœ¼ë¡œ 1ê°œì›”ì”© ì§„í–‰í•˜ê±°ë‚˜, <b>ìë™ ì§„í–‰(10ê°œì›”)</b>ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì§„í–‰í•©ë‹ˆë‹¤.<br/><br/>
        <div class="guideSectionTitle">ì„±ê³µ ëª©í‘œ</div>
        ì‹¤íŒ¨ ì¡°ê±´ì— í•´ë‹¹í•˜ì§€ ì•Šê³  48ê°œì›” ì„ê¸°ë¥¼ ë²„í‹°ë©´ â€œëª…ì˜ˆë¡œìš´ í‡´ì§„â€ ìŠ¹ë¦¬ì…ë‹ˆë‹¤.<br/><br/>
        <div class="guideSectionTitle">ì‹¤íŒ¨ ì¡°ê±´</div>
        - <b>ë¬¼ê°€ í­ë“±</b>: CPIê°€ <b>18 ì´ìƒìœ¼ë¡œ 3ê°œì›” ì—°ì†</b> ì§€ì†ë˜ë©´ ì‹¤íŒ¨<br/>
        - <b>ëŒ€ê³µí™©</b>: ì‹¤ì—…ë¥ ì´ <b>16 ì´ìƒìœ¼ë¡œ 3ê°œì›” ì—°ì†</b> ì§€ì†ë˜ë©´ ì‹¤íŒ¨<br/>
        - <b>ê¸ˆìœµ ë¶•ê´´</b>: ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ê°€ <b>100ì— ë„ë‹¬</b>í•˜ë©´ ì¦‰ì‹œ ì‹¤íŒ¨<br/>
        - <b>ì‚¬íšŒ ë¶•ê´´</b>: <b>ë¯¼ì‹¬ 2 ì´í•˜ + ì‚¬íšŒë¶ˆì•ˆ 95 ì´ìƒ</b>ì´ ë™ì‹œì— ë˜ë©´ ì‹¤íŒ¨<br/><br/>
        <div class="guideSectionTitle">íŒ</div>
        ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë¹ ë¥´ê²Œ ëŒ€ì‘í•˜ë˜, í° í­ì˜ ì¦ì€ ê¸ˆë¦¬ ë³€ê²½ì€ ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í‚¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div>
        <div class="guideSectionTitle">ì§€í‘œ ì„¤ëª…(ê°„ë‹¨)</div>
        - <b>CPI(ë¬¼ê°€)</b>: ë¬¼ê°€ ìƒìŠ¹ë¥ . ë†’ì„ìˆ˜ë¡ ë¯¼ì‹¬ ì•…í™”Â·ì‹¤íŒ¨ ìœ„í—˜ ì¦ê°€.<br/>
        - <b>ì‹¤ì—…ë¥ </b>: ê³ ìš© ìƒíƒœ. ë†’ì•„ì§€ë©´ ê²½ê¸° ë‘”í™”ì™€ ë¯¼ì‹¬ í•˜ë½ì´ ì»¤ì§.<br/>
        - <b>ì„±ì¥ë¥ </b>: ê²½ê¸° í™œë ¥. ë‚®ì•„ì§€ë©´ ì‹¤ì—…ì´ ì˜¤ë¥´ê³  ì „ë°˜ ì§€í‘œê°€ ì•…í™”ë¨.<br/>
        - <b>ìì‚°ì§€ìˆ˜</b>: ì£¼ì‹+ë¶€ë™ì‚° í•©ì„± ì§€ìˆ˜. ê³¼ì—´ ì‹œ ë²„ë¸”Â·ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤ ìœ„í—˜ ì¦ê°€.<br/>
        - <b>ê¸°ëŒ€ì¸í”Œë ˆ</b>: ì˜ˆìƒ ë¬¼ê°€. ë†’ì„ìˆ˜ë¡ CPIê°€ ë” ì‰½ê²Œ ì˜¤ë¦„.<br/>
        - <b>ê¸ˆìœµìŠ¤íŠ¸ë ˆìŠ¤</b>: ê¸ˆìœµì‹œì¥ ë¶ˆì•ˆ. ê¸ˆë¦¬ë¥¼ ìì£¼/í¬ê²Œ ë°”ê¾¸ë©´ ìƒìŠ¹í•˜ë©°, ë†’ì„ìˆ˜ë¡ ìœ„ê¸° ì´ë²¤íŠ¸ í™•ë¥  ì¦ê°€.<br/>
        - <b>ë¯¼ì‹¬</b>: ì •ì±… ì§€ì§€ë„. ë‚®ìœ¼ë©´ ì‚¬íšŒë¶ˆì•ˆ ì¦ê°€.<br/>
        - <b>ì‚¬íšŒë¶ˆì•ˆ</b>: ì‹œìœ„Â·íŒŒì—… ìˆ˜ì¤€. ë†’ìœ¼ë©´ ì‹¤íŒ¨ ìœ„í—˜ ì¦ê°€.<br/><br/>
        <div class="guideSectionTitle">ê¸ˆë¦¬ì˜ ê²½í–¥ + ì‹œì°¨</div>
        - <b>ê¸ˆë¦¬ ì¸ìƒ</b>: CPIÂ·ê¸°ëŒ€ì¸í”Œë ˆ í•˜ë½ ê²½í–¥, ì„±ì¥ë¥  ë‘”í™”Â·ì‹¤ì—… ìƒìŠ¹, ìì‚°ì§€ìˆ˜ ë‘”í™”.<br/>
        - <b>ê¸ˆë¦¬ ì¸í•˜</b>: ì„±ì¥ë¥  íšŒë³µÂ·ì‹¤ì—… í•˜ë½ ê²½í–¥, ìì‚°ì§€ìˆ˜ ìƒìŠ¹, CPI ìƒìŠ¹ ì••ë ¥ ì¦ê°€.<br/>
        - <b>ì‹œì°¨</b>: ê¸ˆë¦¬ íš¨ê³¼ëŠ” ì¦‰ì‹œ ë‚˜íƒ€ë‚˜ì§€ ì•Šê³  <b>ëª‡ í„´ ë’¤ ëˆ„ì </b>ë˜ì–´ ë°˜ì˜ë¨.
      </div>
    </div>
  `;
  guideOverlay.classList.add("show");
  guideOverlay.setAttribute("aria-hidden", "false");
}

let tutorialStage = 0;
function startTutorialPulse(){
  if(tutorialStage !== 0) return;
  tutorialStage = 1;
  const rateBtns = document.querySelectorAll("button[data-delta]");
  rateBtns.forEach(btn => btn.classList.add("tutorPulse"));
}
function advanceTutorialAfterRate(){
  if(tutorialStage !== 1) return;
  tutorialStage = 2;
  const rateBtns = document.querySelectorAll("button[data-delta]");
  rateBtns.forEach(btn => btn.classList.remove("tutorPulse"));
  el("nextBtn").classList.add("tutorPulse");
}
function finishTutorialAfterNext(){
  if(tutorialStage !== 2) return;
  tutorialStage = 3;
  el("nextBtn").classList.remove("tutorPulse");
}

/** -------------------------
 * Policy control
 * --------------------------*/
function applyRateDelta(delta){
  delta = clamp(delta, -0.75, 0.75);
  const newR = clamp(state.r + delta, 0.0, 12.0);
  state.lastRateChange = delta;
  const d = sgn(delta);
  if(d !== 0) state.lastDirection = d;
  state.r = newR;

  // aggressive move penalty if CPI not hot
  if(Math.abs(delta) >= 0.5 && state.cpi < 5){
    state.credibility = clamp(state.credibility - 1.5, 0, 100);
  }
}

/** -------------------------
 * One turn
 * --------------------------*/
let rng = Math.random;
let seedMode = false;
let seedValue = 123456789;

function stepTurn(){
  // 1) Events before macro step (like breaking news)
  const eventLines = maybeEvents(state, rng);

  // 2) Macro step
  const simLogs = stepMonth(state, rng);

  // 3) Reactions
  const react = reactions(state);

  // 4) Advance time
  state.month += 1;

  // 5) Logging
  if(eventLines.length){
    pushLog(eventLines.map(x => `<span class="news">${x}</span>`));
    eventLines.forEach(line => playEventSound(line));
  }
  if(simLogs.length){
    pushLog(simLogs.map(x => `<span class="warn">${x}</span>`));
  }
  if(react.length){
    pushLog(react.map(x => `<strong>${x}</strong>`));
    react.forEach(line => playReactionSound(line));
  }
  const tip = situationTip(state);
  if(tip) pushLog([`<span class="good">${tip}</span>`]);

  // 6) Check ending
  const ending = checkEnding(state);
  renderAll();
  if(ending){
    pushLog([`<span class="bad"><strong>${ending}</strong></span>`]);
    const info = failureInfo(ending, state);
    if(info){
      pushLog(info.map(x => `<span class="warn">${x}</span>`));
      endingText.textContent = `${ending}\n${info.join("\n")}`;
    } else {
      endingText.textContent = ending;
    }
    endingOverlay.classList.add("show");
    endingOverlay.setAttribute("aria-hidden", "false");
    playEndingSound();
    el("nextBtn").disabled = true;
    el("autoBtn").disabled = true;
  }
}

function newGame(){
  state = defaultState();
  state.maxMonths = 48;
  el("nextBtn").disabled = false;
  el("autoBtn").disabled = false;
  endingOverlay.classList.remove("show");
  endingOverlay.setAttribute("aria-hidden", "true");
  clearLog();
  pushLog([
    `<strong>ìƒˆ ê²Œì„ ì‹œì‘</strong> â€” ê¸°ì¤€ê¸ˆë¦¬ë¥¼ ì¡°ì ˆí•˜ì—¬ CPIì™€ ì‹¤ì—…ë¥ ì„ ê´€ë¦¬í•˜ì‹­ì‹œì˜¤.`,
    `ì „ìŸ/íŒ¬ë°ë¯¹/ë²„ë¸”/ì‹ ìš©ê²½ìƒ‰ì´ í•œ ë²ˆ í„°ì§€ë©´ â€œì‹œì°¨â€ ë•Œë¬¸ì— ë’¤ëŠ¦ê²Œ ì§€í‘œê°€ ë” ë‚˜ë¹ ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  ], "");
  renderAll();
}

/** -------------------------
 * Wire UI
 * --------------------------*/
document.querySelectorAll("button[data-delta]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    ensureAudio();
    const delta = Number(btn.dataset.delta);
    applyRateDelta(delta);
    renderAll();
    advanceTutorialAfterRate();
  });
});

guideCloseBtn?.addEventListener("click", ()=>{
  guideOverlay.classList.remove("show");
  guideOverlay.setAttribute("aria-hidden", "true");
  startTutorialPulse();
});

guideBtn?.addEventListener("click", ()=>{
  showGuideOverlay();
});

el("nextBtn").addEventListener("click", ()=>{
  ensureAudio();
  stepTurn();
  finishTutorialAfterNext();
});

el("autoBtn").addEventListener("click", ()=>{
  ensureAudio();
  // run 10 months quickly
  for(let i=0;i<10;i++){
    if(el("nextBtn").disabled) break;
    stepTurn();
  }
});

el("resetBtn").addEventListener("click", ()=>{
  newGame();
});

endingRestartBtn.addEventListener("click", ()=>{
  ensureAudio();
  newGame();
});

el("difficulty").addEventListener("change", (e)=>{
  difficulty = e.target.value;
  renderAll();
});


(function intro(){
  if(!introOverlay || !introVideo) return;
  const closeIntro = ()=>{
    introOverlay.classList.remove("show");
    introOverlay.setAttribute("aria-hidden", "true");
    introVideo.pause();
    showStartFlash();
    playStartSound();
    showGuideOverlay();
  };
  introMuteBtn.addEventListener("click", ()=>{
    ensureAudio();
    const nowMuted = !introVideo.muted ? true : false;
    introVideo.muted = nowMuted;
    introVideo.volume = nowMuted ? 0.0 : 0.9;
    introMuteBtn.textContent = nowMuted ? "ìŒì†Œê±° í•´ì œ" : "ìŒì†Œê±°";
  });
  introOverlay.addEventListener("click", (e)=>{
    if(e.target === introOverlay) closeIntro();
  });
  introVideo.addEventListener("ended", closeIntro);
  introVideo.addEventListener("error", closeIntro);
})();

(function startScreen(){
  if(!startOverlay || !startBtn || !introOverlay || !introVideo) return;
  startBtn.addEventListener("click", ()=>{
    ensureAudio();
    startOverlay.classList.remove("show");
    startOverlay.setAttribute("aria-hidden", "true");
    introOverlay.classList.add("show");
    introOverlay.setAttribute("aria-hidden", "false");
    introVideo.muted = false;
    introVideo.volume = 0.9;
    if(introMuteBtn) introMuteBtn.textContent = "ìŒì†Œê±°";
    introVideo.play().catch(()=>{});
  });
})();

(function init(){
  // default RNG
  rng = Math.random;
  renderAll();
  newGame();
})();
</script>
</body>
</html>
